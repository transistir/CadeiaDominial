# Plano de Melhorias - Formul치rio de Lan칞amento

## An치lise da Situa칞칚o Atual

### Tipos de Documento
- **Transcri칞칚o**: Documento que transcreve informa칞칫es de outro documento
- **Matr칤cula**: Documento principal de registro do im칩vel

### Tipos de Lan칞amento por Documento
- **Matr칤cula**: Averba칞칚o, Registro, In칤cio de Matr칤cula
- **Transcri칞칚o**: Averba칞칚o, In칤cio de Matr칤cula (n칚o tem Registro)

### Estrutura Atual
- Formul치rio com campos b치sicos (livro, folha, data, cart칩rio)
- Campos espec칤ficos por tipo de lan칞amento
- Sistema de autocomplete para pessoas e cart칩rios
- Gera칞칚o autom치tica de n칰meros de lan칞amento

## Demandas dos Usu치rios

### 1. Melhorias na Tela "Novo Lan칞amento"

#### 1.1 Destaque da Matr칤cula
- **Problema**: Matr칤cula n칚o est치 em evid칡ncia
- **Solu칞칚o**: Criar se칞칚o destacada no topo do formul치rio

#### 1.2 Abolir Livro e Folha em Lan칞amentos Repetidos
- **Problema**: Usu치rios precisam preencher livro/folha em todos os lan칞amentos
- **Solu칞칚o**: 
  - Herdar automaticamente do documento pai
  - Permitir edi칞칚o apenas quando necess치rio
  - Mostrar visualmente que s칚o herdados

#### 1.3 Campo de 츼rea
- **Problema**: N칚o existe campo de 치rea
- **Solu칞칚o**: Adicionar campo com 4 casas decimais

#### 1.4 Visualiza칞칚o de Lan칞amentos Anteriores
- **Problema**: N칚o 칠 poss칤vel ver lan칞amentos j치 feitos
- **Solu칞칚o**: Adicionar tabela/listagem dos lan칞amentos existentes

#### 1.5 Trocar "Cart칩rio" por "Registro Imobili치rio"
- **Problema**: Terminologia incorreta
- **Solu칞칚o**: Alterar labels e textos

#### 1.6 Impedir Cria칞칚o de Cart칩rios Novos
- **Problema**: Usu치rios podem criar cart칩rios inexistentes
- **Solu칞칚o**: For칞ar sele칞칚o apenas de cart칩rios existentes

#### 1.7 Separar Cart칩rios de Registro e Notas
- **Problema**: Cart칩rios de notas aparecem na lista de registros
- **Solu칞칚o**: Criar categoriza칞칚o de cart칩rios

#### 1.8 Campos Opcionais para Averba칞칚o
- **Problema**: Averba칞칚o n칚o tem campos de transmitentes/adquirentes
- **Solu칞칚o**: Adicionar campos opcionais

### 2. Melhorias na Origem

#### 2.1 Op칞칫es de Origem Estruturadas
- **Problema**: Campo livre pode causar inconsist칡ncias
- **Solu칞칚o**: Criar op칞칫es estruturadas:
  - Matr칤cula (n칰mero + CRI)
  - Transcri칞칚o (n칰mero + CRI)
  - Outra (especifica칞칚o livre)
  - Destacamento do patrim칪nio p칰blico
  - Registro (n칰mero + livro + cart칩rio)
  - Sem origem (reprodu칞칚o de fala)

#### 2.2 Finaliza칞칚o da Cadeia
- **Problema**: N칚o h치 indica칞칚o clara quando a cadeia termina
- **Solu칞칚o**: 
  - Marcar visualmente documentos finais
  - Solicitar classifica칞칚o da origem:
    - Im칩vel com origem l칤dima
    - Im칩vel sem origem
    - Situa칞칚o inconclusa

#### 2.3 Lista de Im칩veis por Origem
- **Problema**: N칚o h치 relat칩rio de im칩veis por tipo de origem
- **Solu칞칚o**: Criar relat칩rio/listagem

## Plano de Implementa칞칚o

### Fase 1: Melhorias Visuais e UX

#### 1.1 Destaque da Matr칤cula
```html
<!-- Novo componente: _documento_destaque.html -->
<div class="documento-destaque">
    <h3>游늶 {{ documento.tipo.get_tipo_display }} {{ documento.numero }}</h3>
    <div class="documento-info">
        <span><strong>Registro Imobili치rio:</strong> {{ documento.cartorio.nome }}</span>
        <span><strong>Livro:</strong> {{ documento.livro }}</span>
        <span><strong>Folha:</strong> {{ documento.folha }}</span>
    </div>
</div>
```

#### 1.2 Heran칞a de Livro/Folha
```python
# Modificar LancamentoFormService
def processar_dados_lancamento(request, tipo_lanc):
    dados = {}
    # ... c칩digo existente ...
    
    # Herdar livro e folha do documento se n칚o fornecidos
    if not dados.get('livro_origem'):
        dados['livro_origem'] = documento_ativo.livro
    if not dados.get('folha_origem'):
        dados['folha_origem'] = documento_ativo.folha
    
    return dados
```

#### 1.3 Campo de 츼rea com 4 Casas Decimais
```python
# Modificar modelo Lancamento
area = models.DecimalField(
    max_digits=12, 
    decimal_places=4,  # Alterar de 2 para 4
    null=True, 
    blank=True,
    help_text="츼rea em hectares com 4 casas decimais"
)
```

### Fase 2: Melhorias na Interface

#### 2.1 Listagem de Lan칞amentos Existentes
```html
<!-- Novo componente: _lancamentos_existentes.html -->
<div class="lancamentos-existentes">
    <h4>Lan칞amentos Existentes</h4>
    <table class="table">
        <thead>
            <tr>
                <th>N칰mero</th>
                <th>Tipo</th>
                <th>Data</th>
                <th>츼rea</th>
                <th>A칞칫es</th>
            </tr>
        </thead>
        <tbody>
            {% for lanc in lancamentos_existentes %}
            <tr>
                <td>{{ lanc.numero_lancamento }}</td>
                <td>{{ lanc.tipo.get_tipo_display }}</td>
                <td>{{ lanc.data|date:'d/m/Y' }}</td>
                <td>{{ lanc.area|floatformat:4 }}</td>
                <td>
                    <a href="{% url 'editar_lancamento' ... %}" class="btn btn-sm btn-primary">Editar</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
```

#### 2.2 Troca de Terminologia
```html
<!-- Modificar _lancamento_basico_form.html -->
<div class="form-group">
    <label for="cartorio">Registro Imobili치rio *</label>
    <div class="autocomplete-container">
        <input type="text" name="cartorio_nome" id="cartorio_nome" 
               placeholder="Digite o nome do registro imobili치rio" autocomplete="off" required>
        <!-- ... resto do c칩digo ... -->
    </div>
</div>
```

### Fase 3: Valida칞칫es e Controles

#### 3.1 Impedir Cria칞칚o de Cart칩rios
```javascript
// Modificar lancamento_form.js
function setupCartorioAutocomplete(input, hidden, suggestions) {
    // ... c칩digo existente ...
    
    // Impedir cria칞칚o de novos cart칩rios
    input.addEventListener('blur', function() {
        const selectedValue = hidden.value;
        if (!selectedValue) {
            input.value = '';
            showError('Selecione um registro imobili치rio existente');
        }
    });
}
```

#### 3.2 Categoriza칞칚o de Cart칩rios
```python
# Adicionar ao modelo Cartorios
TIPO_CHOICES = [
    ('registro', 'Registro Imobili치rio'),
    ('notas', 'Cart칩rio de Notas'),
    ('outro', 'Outro')
]
tipo = models.CharField(max_length=20, choices=TIPO_CHOICES, default='registro')
```

### Fase 4: Sistema de Origem Estruturado

#### 4.1 Novo Modelo para Origem
```python
class OrigemTipo(models.Model):
    TIPO_CHOICES = [
        ('matricula', 'Matr칤cula'),
        ('transcricao', 'Transcri칞칚o'),
        ('outra', 'Outra'),
        ('destacamento', 'Destacamento do Patrim칪nio P칰blico'),
        ('registro', 'Registro'),
        ('sem_origem', 'Sem Origem')
    ]
    
    tipo = models.CharField(max_length=20, choices=TIPO_CHOICES)
    descricao = models.TextField()
    especificacao = models.CharField(max_length=255, blank=True)
    
    class Meta:
        verbose_name = "Tipo de Origem"
        verbose_name_plural = "Tipos de Origem"

class OrigemClassificacao(models.Model):
    CLASSIFICACAO_CHOICES = [
        ('l칤dima', 'Im칩vel com Origem L칤dima'),
        ('sem_origem', 'Im칩vel Sem Origem'),
        ('inconclusa', 'Situa칞칚o Inconclusa')
    ]
    
    documento = models.OneToOneField('Documento', on_delete=models.CASCADE)
    classificacao = models.CharField(max_length=20, choices=CLASSIFICACAO_CHOICES)
    observacoes = models.TextField(blank=True)
    
    class Meta:
        verbose_name = "Classifica칞칚o de Origem"
        verbose_name_plural = "Classifica칞칫es de Origem"
```

#### 4.2 Formul치rio de Origem Estruturado
```html
<!-- Novo componente: _origem_estruturada.html -->
<div class="origem-estruturada">
    <h4>Origem do Documento</h4>
    
    <div class="form-group">
        <label>Tipo de Origem *</label>
        <select name="tipo_origem" id="tipo_origem" required>
            <option value="">Selecione...</option>
            <option value="matricula">Matr칤cula</option>
            <option value="transcricao">Transcri칞칚o</option>
            <option value="outra">Outra</option>
            <option value="destacamento">Destacamento do Patrim칪nio P칰blico</option>
            <option value="registro">Registro</option>
            <option value="sem_origem">Sem Origem</option>
        </select>
    </div>
    
    <!-- Campos espec칤ficos por tipo -->
    <div id="campos-matricula" class="campos-origem hidden">
        <div class="grid-2">
            <div class="form-group">
                <label for="numero_matricula">N칰mero da Matr칤cula</label>
                <input type="text" name="numero_matricula" id="numero_matricula">
            </div>
            <div class="form-group">
                <label for="cri_matricula">CRI</label>
                <input type="text" name="cri_matricula" id="cri_matricula">
            </div>
        </div>
    </div>
    
    <!-- Outros campos espec칤ficos... -->
</div>
```

### Fase 5: Relat칩rios e Listagens

#### 5.1 Relat칩rio de Im칩veis por Origem
```python
# Nova view
@login_required
def relatorio_origem_imoveis(request, tis_id):
    tis = get_object_or_404(TIs, id=tis_id)
    
    # Agrupar im칩veis por classifica칞칚o de origem
    imoveis_por_origem = {}
    
    for imovel in tis.imoveis.all():
        documentos = imovel.documentos.all()
        for documento in documentos:
            try:
                classificacao = documento.origemclassificacao.classificacao
                if classificacao not in imoveis_por_origem:
                    imoveis_por_origem[classificacao] = []
                imoveis_por_origem[classificacao].append(imovel)
            except:
                # Documento sem classifica칞칚o
                if 'sem_classificacao' not in imoveis_por_origem:
                    imoveis_por_origem['sem_classificacao'] = []
                imoveis_por_origem['sem_classificacao'].append(imovel)
    
    context = {
        'tis': tis,
        'imoveis_por_origem': imoveis_por_origem
    }
    
    return render(request, 'dominial/relatorio_origem_imoveis.html', context)
```

## Cronograma de Implementa칞칚o

### Semana 1: Prepara칞칚o
- [ ] Criar branch de desenvolvimento
- [ ] Revisar estrutura atual dos modelos
- [ ] Definir migra칞칫es necess치rias

### Semana 2: Melhorias Visuais
- [ ] Implementar destaque da matr칤cula
- [ ] Adicionar campo de 치rea com 4 casas decimais
- [ ] Trocar terminologia "Cart칩rio" por "Registro Imobili치rio"

### Semana 3: Funcionalidades de UX
- [ ] Implementar heran칞a de livro/folha
- [ ] Adicionar listagem de lan칞amentos existentes
- [ ] Implementar valida칞칫es para cart칩rios existentes

### Semana 4: Sistema de Origem
- [ ] Criar modelos para origem estruturada
- [ ] Implementar formul치rio de origem
- [ ] Adicionar classifica칞칚o de origem

### Semana 5: Relat칩rios e Testes
- [ ] Implementar relat칩rio de im칩veis por origem
- [ ] Testes de integra칞칚o
- [ ] Documenta칞칚o das mudan칞as

### Semana 6: Refinamentos
- [ ] Ajustes baseados em feedback
- [ ] Otimiza칞칫es de performance
- [ ] Deploy em ambiente de teste

## Considera칞칫es T칠cnicas

### Migra칞칫es Necess치rias
1. Alterar campo `area` para 4 casas decimais
2. Adicionar campo `tipo` ao modelo `Cartorios`
3. Criar novos modelos `OrigemTipo` e `OrigemClassificacao`

### Impactos no Sistema
- Formul치rios existentes precisar칚o ser atualizados
- JavaScript precisa ser modificado para novas valida칞칫es
- Templates precisam ser adaptados para nova terminologia

### Compatibilidade
- Manter compatibilidade com dados existentes
- Migra칞칚o gradual dos dados
- Documenta칞칚o das mudan칞as para usu치rios

## Pr칩ximos Passos

1. **Aprova칞칚o do Plano**: Revisar e aprovar este plano
2. **Prioriza칞칚o**: Definir quais melhorias s칚o mais cr칤ticas
3. **Desenvolvimento**: Iniciar implementa칞칚o seguindo o cronograma
4. **Testes**: Testes extensivos com usu치rios reais
5. **Deploy**: Implementa칞칚o gradual em produ칞칚o 