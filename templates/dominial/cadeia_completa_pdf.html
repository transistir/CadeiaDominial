{# ===================================================== #}
{# TEMPLATE PARA GERA√á√ÉO DE PDF - CADEIA COMPLETA      #}
{# ===================================================== #}
{# Este template √© usado pela view exportar_cadeia_completa_pdf #}
{# para gerar PDFs da cadeia dominial COMPLETA usando WeasyPrint    #}

{# Carrega os filtros customizados do Django (como 'split', 'strip') #}
{% load dominial_extras %}
{# Carrega os arquivos est√°ticos (CSS, JS, imagens) #}
{% load static %}

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {# T√≠tulo din√¢mico baseado no nome do im√≥vel #}
    <title>Cadeia Dominial Completa - {{ imovel.nome }}</title>
    {# Link para o CSS espec√≠fico do PDF (formato paisagem, fontes pequenas) #}
    <link rel="stylesheet" href="{% static 'dominial/css/cadeia_completa_pdf.css' %}">
</head>
<body>
    {# ===================================================== #}
    {# CABE√áALHO DO PDF - INFORMA√á√ïES PRINCIPAIS           #}
    {# ===================================================== #}
    <div class="header">
        <h1>CADEIA DOMINIAL COMPLETA</h1>
        {# Informa√ß√µes do im√≥vel e matr√≠cula #}
        <p><strong>Im√≥vel:</strong> {{ imovel.nome }} | <strong>Matr√≠cula:</strong> {{ imovel.matricula }}</p>
        {# Data/hora de gera√ß√£o do PDF #}
        <p>Relat√≥rio completo gerado em {{ "now"|date:"d/m/Y H:i" }} | Sistema Cadeia Dominial</p>
    </div>

    {# ===================================================== #}
    {# TABELA DE INFORMA√á√ïES DO IM√ìVEL                     #}
    {# ===================================================== #}
    <div class="imovel-info">
        {# Cada linha mostra um campo do im√≥vel #}
        <div class="imovel-info-row">
            <div class="imovel-info-cell">Im√≥vel:</div>
            <div class="imovel-info-cell">{{ imovel.nome }}</div>
        </div>
        <div class="imovel-info-row">
            <div class="imovel-info-cell">Matr√≠cula:</div>
            <div class="imovel-info-cell">{{ imovel.matricula }}</div>
        </div>
        <div class="imovel-info-row">
            <div class="imovel-info-cell">Propriet√°rio:</div>
            <div class="imovel-info-cell">{{ imovel.proprietario.nome }}</div>
        </div>
        {# Campos opcionais - s√≥ aparecem se existirem #}
        {% if imovel.sncr %}
        <div class="imovel-info-row">
            <div class="imovel-info-cell">SNCR:</div>
            <div class="imovel-info-cell">{{ imovel.sncr }}</div>
        </div>
        {% endif %}
        {% if imovel.cartorio %}
        <div class="imovel-info-row">
            <div class="imovel-info-cell">Cart√≥rio:</div>
            <div class="imovel-info-cell">{{ imovel.cartorio.nome }}</div>
        </div>
        {% endif %}
    </div>

    {# ===================================================== #}
    {# VERIFICA√á√ïES DE DADOS - ESTADOS VAZIOS              #}
    {# ===================================================== #}
    {# Se n√£o h√° cadeia completa #}
    {% if not cadeia_completa %}
        <div class="empty-state">
            <h3>Nenhum documento encontrado</h3>
            <p>Esta cadeia dominial ainda n√£o possui documentos registrados.</p>
        </div>
    {% else %}
        {# ===================================================== #}
        {# CONTE√öDO PRINCIPAL - CADAIA COMPLETA               #}
        {# ===================================================== #}
        {% for tronco in cadeia_completa %}
            {# ===================================================== #}
            {# SE√á√ÉO DE TRONCO (PRINCIPAL OU SECUND√ÅRIO)          #}
            {# ===================================================== #}
            <div class="tronco-section">
                <h2>{{ tronco.titulo }}</h2>
                
                {# ===================================================== #}
                {# LOOP DOS DOCUMENTOS DO TRONCO                      #}
                {# ===================================================== #}
                {% for item in tronco.documentos %}
                    {# ===================================================== #}
                    {# SE√á√ÉO DE DOCUMENTO INDIVIDUAL                       #}
                    {# ===================================================== #}
                    {# Classe CSS especial se for documento importado #}
                    <div class="documento-section {% if item.is_importado %}documento-importado{% endif %}">
                        {# Cabe√ßalho do documento com informa√ß√µes b√°sicas #}
                        <div class="documento-header">
                            üìÑ {{ item.documento.tipo.get_tipo_display }}: {{ item.documento.numero }}
                            {# Badge especial para documentos importados #}
                            {% if item.is_importado %}
                                <span class="badge-importado">üì• Importado</span>
                            {% endif %}
                            <br>
                            <small>
                                Data: {{ item.documento.data|date:"d/m/Y" }} | 
                                Cart√≥rio: {{ item.documento.cartorio.nome }} | 
                                Lan√ßamentos: {{ item.lancamentos.count }}
                            </small>
                        </div>
                        
                        {# ===================================================== #}
                        {# TABELA DE LAN√áAMENTOS DO DOCUMENTO               #}
                        {# ===================================================== #}
                        {% if item.lancamentos %}
                        <table class="lancamentos-table">
                            <thead>
                                {# Primeira linha do cabe√ßalho - agrupamentos #}
                                <tr>
                                    <th colspan="5" class="agrupamento">MATR√çCULA</th>
                                    <th colspan="2" class="agrupamento">&nbsp;</th>
                                    <th colspan="6" class="agrupamento">TRANSMISS√ÉO</th>
                                    <th rowspan="2">√Årea (ha)</th>
                                    <th rowspan="2">Origem</th>
                                    <th rowspan="2">Observa√ß√µes</th>
                                </tr>
                                {# Segunda linha do cabe√ßalho - colunas espec√≠ficas #}
                                <tr>
                                    <!-- Colunas da Matr√≠cula -->
                                    <th>N¬∫</th>
                                    <th>L</th>
                                    <th>Fls.</th>
                                    <th>Cart√≥rio</th>
                                    <th>Data</th>
                                    <!-- Colunas de Transmitente/Adquirente -->
                                    <th>Transmitente</th>
                                    <th>Adquirente</th>
                                    <!-- Colunas da Transmiss√£o -->
                                    <th>Forma</th>
                                    <th>T√≠tulo</th>
                                    <th>Cart√≥rio</th>
                                    <th>L</th>
                                    <th>Fls.</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody>
                                {# ===================================================== #}
                                {# LOOP DOS LAN√áAMENTOS INDIVIDUAIS                   #}
                                {# ===================================================== #}
                                {% for lancamento in item.lancamentos %}
                                {# Alterna cores das linhas (par/√≠mpar) #}
                                <tr class="{% cycle 'linha-par' 'linha-impar' %}">
                                    {# ===================================================== #}
                                    {# COLUNAS DA MATR√çCULA                               #}
                                    {# ===================================================== #}
                                    <td>{{ lancamento|numero_documento_criado }}</td>
                                    <td>{{ item.documento.livro|default_if_none:"-" }}</td>
                                    <td>{{ item.documento.folha|default_if_none:"-" }}</td>
                                    <td>{{ item.documento.cartorio.nome }}</td>
                                    <td>{{ lancamento.data|date:'d/m/Y' }}</td>
                                    
                                    {# ===================================================== #}
                                    {# COLUNAS DE PESSOAS (TRANSMITENTE/ADQUIRENTE)        #}
                                    {# ===================================================== #}
                                    <!-- Transmitente - lista todas as pessoas -->
                                    <td>
                                        {% for pessoa in lancamento.transmitentes.all %}
                                            {{ pessoa.pessoa.nome }}{% if not forloop.last %}, {% endif %}
                                        {% empty %}-{% endfor %}
                                    </td>
                                    <!-- Adquirente - lista todas as pessoas -->
                                    <td>
                                        {% for pessoa in lancamento.adquirentes.all %}
                                            {{ pessoa.pessoa.nome }}{% if not forloop.last %}, {% endif %}
                                        {% empty %}-{% endfor %}
                                    </td>
                                    
                                    {# ===================================================== #}
                                    {# COLUNAS DA TRANSMISS√ÉO                              #}
                                    {# ===================================================== #}
                                    {# L√≥gica especial para averba√ß√µes vs transcri√ß√µes #}
                                    {% if lancamento.tipo.tipo == 'averbacao' and item.documento.tipo.tipo != 'transcricao' %}
                                        {# Para averba√ß√µes, mostra descri√ß√£o em todas as colunas #}
                                        <td colspan="6">{{ lancamento.descricao|default_if_none:"-" }}</td>
                                    {% else %}
                                        {# Para transcri√ß√µes, mostra dados detalhados #}
                                        <td>{{ lancamento.forma|default_if_none:"-" }}</td>
                                        <td>{{ lancamento.titulo|default_if_none:"-" }}</td>
                                        <td>{% if lancamento.cartorio_transmissao_compat %}{{ lancamento.cartorio_transmissao_compat.nome }}{% else %}-{% endif %}</td>
                                        <td>{{ lancamento.livro_transacao|default_if_none:"-" }}</td>
                                        <td>{{ lancamento.folha_transacao|default_if_none:"-" }}</td>
                                        <td>
                                            {% if lancamento.data_transacao %}
                                                {{ lancamento.data_transacao|date:'d/m/Y' }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                    {% endif %}
                                    
                                    {# ===================================================== #}
                                    {# COLUNAS ADICIONAIS                                  #}
                                    {# ===================================================== #}
                                    <!-- √Årea do im√≥vel -->
                                    <td>{{ lancamento.area|default_if_none:"-" }}</td>
                                    <!-- Origem - pode ter m√∫ltiplas origens separadas por ';' -->
                                    <!-- <td>
                                      {% if lancamento.origem %}
                                        {% if ';' in lancamento.origem %}
                                          {# Se tem m√∫ltiplas origens, quebra por ';' e mostra cada uma #}
                                          {% for origem in lancamento.origem|split:';' %}
                                            <div>{{ origem|strip }}</div>
                                          {% endfor %}
                                        {% else %}
                                          {# Se tem apenas uma origem #}
                                          {{ lancamento.origem }}
                                        {% endif %}
                                      {% else %}
                                        -
                                      {% endif %}
                                    </td> -->
                                    <td>
                                        {% if lancamento.origem %}
                                          {% if ';' in lancamento.origem %}
                                            {% for origem in lancamento.origem|split:';' %}
                                              <div>
                                                {{ lancamento|origem_formatada }}
                                                {% with cartorio_nome=lancamento|origem_cartorio_especifico:origem %}
                                                  {% if cartorio_nome %}
                                                    <small class="text-muted">({{ cartorio_nome }})</small>
                                                  {% endif %}
                                                {% endwith %}
                                              </div>
                                            {% endfor %}
                                          {% else %}
                                            {{ lancamento|origem_formatada }}
                                            {% if lancamento.cartorio_origem %}
                                              <small class="text-muted">({{ lancamento.cartorio_origem.nome }})</small>
                                            {% endif %}
                                          {% endif %}
                                        {% else %}
                                          -
                                        {% endif %}
                                      </td>
                                    <!-- Observa√ß√µes do lan√ßamento -->
                                    <td>{{ lancamento.observacoes|default_if_none:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
        
        {# ===================================================== #}
        {# SE√á√ÉO DE ESTAT√çSTICAS                               #}
        {# ===================================================== #}
        {% if estatisticas %}
        <div class="estatisticas">
            <h3>üìà Estat√≠sticas da Cadeia Completa</h3>
            <div class="estatisticas-grid">
                <div class="estatisticas-item">
                    <div class="estatisticas-valor">{{ estatisticas.total_documentos }}</div>
                    <div class="estatisticas-label">Documentos</div>
                </div>
                <div class="estatisticas-item">
                    <div class="estatisticas-valor">{{ estatisticas.total_lancamentos }}</div>
                    <div class="estatisticas-label">Lan√ßamentos</div>
                </div>
                <div class="estatisticas-item">
                    <div class="estatisticas-valor">{{ estatisticas.total_troncos }}</div>
                    <div class="estatisticas-label">Troncos</div>
                </div>
                <div class="estatisticas-item">
                    <div class="estatisticas-valor">{{ estatisticas.documentos_importados }}</div>
                    <div class="estatisticas-label">Importados</div>
                </div>
            </div>
        </div>
        {% endif %}
    {% endif %}
    

</body>
</html>
