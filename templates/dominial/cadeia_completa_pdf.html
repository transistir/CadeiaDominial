{# ===================================================== #}
{# TEMPLATE PARA GERA칂츾O DE PDF - CADEIA COMPLETA      #}
{# ===================================================== #}
{# Este template 칠 usado pela view exportar_cadeia_completa_pdf #}
{# para gerar PDFs da cadeia dominial COMPLETA usando WeasyPrint    #}

{# Carrega os filtros customizados do Django (como 'split', 'strip') #}
{% load dominial_extras %}
{# Carrega os arquivos est치ticos (CSS, JS, imagens) #}
{% load static %}

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {# T칤tulo din칙mico baseado no nome do im칩vel #}
    <title>Cadeia Dominial Completa - {{ imovel.nome }}</title>
    {# Link para o CSS espec칤fico do PDF (formato paisagem, fontes pequenas) #}
    <link rel="stylesheet" href="{% static 'dominial/css/cadeia_completa_pdf.css' %}">
</head>
<body>
    {# ===================================================== #}
    {# CABE칂ALHO DO PDF - INFORMA칂칏ES PRINCIPAIS           #}
    {# ===================================================== #}
    <div class="header">
        <h1>CADEIA DOMINIAL COMPLETA</h1>
        {# Informa칞칫es do im칩vel e matr칤cula #}
        <p><strong>Im칩vel:</strong> {{ imovel.nome }} | <strong>Matr칤cula:</strong> {{ imovel.matricula }}</p>
        {# Data/hora de gera칞칚o do PDF #}
        <p>Relat칩rio completo gerado em {{ "now"|date:"d/m/Y H:i" }} | Sistema Cadeia Dominial</p>
    </div>

    {# ===================================================== #}
    {# TABELA DE INFORMA칂칏ES DO IM칍VEL                     #}
    {# ===================================================== #}
    <div class="imovel-info">
        {# Cada linha mostra um campo do im칩vel #}
        <div class="imovel-info-row">
            <div class="imovel-info-cell">Im칩vel:</div>
            <div class="imovel-info-cell">{{ imovel.nome }}</div>
        </div>
        <div class="imovel-info-row">
            <div class="imovel-info-cell">Matr칤cula:</div>
            <div class="imovel-info-cell">{{ imovel.matricula }}</div>
        </div>
        <div class="imovel-info-row">
            <div class="imovel-info-cell">Propriet치rio:</div>
            <div class="imovel-info-cell">{{ imovel.proprietario.nome }}</div>
        </div>
        {# Campos opcionais - s칩 aparecem se existirem #}
        {% if imovel.sncr %}
        <div class="imovel-info-row">
            <div class="imovel-info-cell">SNCR:</div>
            <div class="imovel-info-cell">{{ imovel.sncr }}</div>
        </div>
        {% endif %}
        {% if imovel.cartorio %}
        <div class="imovel-info-row">
            <div class="imovel-info-cell">Cart칩rio:</div>
            <div class="imovel-info-cell">{{ imovel.cartorio.nome }}</div>
        </div>
        {% endif %}
    </div>

    {# ===================================================== #}
    {# VERIFICA칂칏ES DE DADOS - ESTADOS VAZIOS              #}
    {# ===================================================== #}
    {# Se n칚o h치 cadeia completa #}
    {% if not cadeia_completa %}
        <div class="empty-state">
            <h3>Nenhum documento encontrado</h3>
            <p>Esta cadeia dominial ainda n칚o possui documentos registrados.</p>
        </div>
    {% else %}
        {# ===================================================== #}
        {# CONTE칔DO PRINCIPAL - CADAIA COMPLETA               #}
        {# ===================================================== #}
        {% for tronco in cadeia_completa %}
            {# ===================================================== #}
            {# SE칂츾O DE TRONCO (PRINCIPAL OU SECUND츼RIO)          #}
            {# ===================================================== #}
            <div class="tronco-section">
                <h2>{{ tronco.titulo }}</h2>
                
                {# ===================================================== #}
                {# LOOP DOS DOCUMENTOS DO TRONCO                      #}
                {# ===================================================== #}
                {% for item in tronco.documentos %}
                    {# ===================================================== #}
                    {# SE칂츾O DE DOCUMENTO INDIVIDUAL                       #}
                    {# ===================================================== #}
                    {# Classe CSS especial se for documento importado #}
                    <div class="documento-section {% if item.is_importado %}documento-importado{% endif %}">
                        {# Cabe칞alho do documento com informa칞칫es b치sicas #}
                        <div class="documento-header">
                            游늯 {{ item.documento.tipo.get_tipo_display }}: {{ item.documento.numero }}
                            {# Badge especial para documentos importados #}
                            {% if item.is_importado %}
                                <span class="badge-importado">游닌 Importado</span>
                            {% endif %}
                            <br>
                            <small>
                                Data: {{ item.documento.data|date:"d/m/Y" }} | 
                                Cart칩rio: {{ item.documento.cartorio.nome }} | 
                                Lan칞amentos: {{ item.lancamentos.count }}
                            </small>
                        </div>
                        
                        {# ===================================================== #}
                        {# TABELA DE LAN칂AMENTOS DO DOCUMENTO               #}
                        {# ===================================================== #}
                        {% if item.lancamentos %}
                        <table class="lancamentos-table">
                            <thead>
                                {# Primeira linha do cabe칞alho - agrupamentos #}
                                <tr>
                                    <th colspan="5" class="agrupamento">MATR칈CULA</th>
                                    <th colspan="2" class="agrupamento">&nbsp;</th>
                                    <th colspan="6" class="agrupamento">TRANSMISS츾O</th>
                                    <th rowspan="2">츼rea (ha)</th>
                                    <th rowspan="2">Origem</th>
                                    <th rowspan="2">Observa칞칫es</th>
                                </tr>
                                {# Segunda linha do cabe칞alho - colunas espec칤ficas #}
                                <tr>
                                    <!-- Colunas da Matr칤cula -->
                                    <th>N췈</th>
                                    <th>L</th>
                                    <th>Fls.</th>
                                    <th>Cart칩rio</th>
                                    <th>Data</th>
                                    <!-- Colunas de Transmitente/Adquirente -->
                                    <th>Transmitente</th>
                                    <th>Adquirente</th>
                                    <!-- Colunas da Transmiss칚o -->
                                    <th>Forma</th>
                                    <th>T칤tulo</th>
                                    <th>Cart칩rio</th>
                                    <th>L</th>
                                    <th>Fls.</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody>
                                {# ===================================================== #}
                                {# LOOP DOS LAN칂AMENTOS INDIVIDUAIS                   #}
                                {# ===================================================== #}
                                {% for lancamento in item.lancamentos %}
                                {# Alterna cores das linhas (par/칤mpar) #}
                                <tr class="{% cycle 'linha-par' 'linha-impar' %}">
                                    {# ===================================================== #}
                                    {# COLUNAS DA MATR칈CULA                               #}
                                    {# ===================================================== #}
                                    <td>{{ lancamento|numero_documento_criado }}</td>
                                    <td>{{ item.documento.livro|default_if_none:"-" }}</td>
                                    <td>{{ item.documento.folha|default_if_none:"-" }}</td>
                                    <td>{{ item.documento.cartorio.nome }}</td>
                                    <td>{{ lancamento.data|date:'d/m/Y' }}</td>
                                    
                                    {# ===================================================== #}
                                    {# COLUNAS DE PESSOAS (TRANSMITENTE/ADQUIRENTE)        #}
                                    {# ===================================================== #}
                                    <!-- Transmitente - lista todas as pessoas -->
                                    <td>
                                        {% for pessoa in lancamento.transmitentes.all %}
                                            {{ pessoa.pessoa.nome }}{% if not forloop.last %}, {% endif %}
                                        {% empty %}-{% endfor %}
                                    </td>
                                    <!-- Adquirente - lista todas as pessoas -->
                                    <td>
                                        {% for pessoa in lancamento.adquirentes.all %}
                                            {{ pessoa.pessoa.nome }}{% if not forloop.last %}, {% endif %}
                                        {% empty %}-{% endfor %}
                                    </td>
                                    
                                    {# ===================================================== #}
                                    {# COLUNAS DA TRANSMISS츾O                              #}
                                    {# ===================================================== #}
                                    {# L칩gica especial para averba칞칫es vs transcri칞칫es #}
                                    {% if lancamento.tipo.tipo == 'averbacao' and item.documento.tipo.tipo != 'transcricao' %}
                                        {# Para averba칞칫es, mostra descri칞칚o em todas as colunas #}
                                        <td colspan="6">{{ lancamento.descricao|default_if_none:"-" }}</td>
                                    {% else %}
                                        {# Para transcri칞칫es, mostra dados detalhados #}
                                        <td>{{ lancamento.forma|default_if_none:"-" }}</td>
                                        <td>{{ lancamento.titulo|default_if_none:"-" }}</td>
                                        <td>{% if lancamento.cartorio_transmissao_compat %}{{ lancamento.cartorio_transmissao_compat.nome }}{% else %}-{% endif %}</td>
                                        <td>{{ lancamento.livro_transacao|default_if_none:"-" }}</td>
                                        <td>{{ lancamento.folha_transacao|default_if_none:"-" }}</td>
                                        <td>
                                            {% if lancamento.data_transacao %}
                                                {{ lancamento.data_transacao|date:'d/m/Y' }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                    {% endif %}
                                    
                                    {# ===================================================== #}
                                    {# COLUNAS ADICIONAIS                                  #}
                                    {# ===================================================== #}
                                    <!-- 츼rea do im칩vel -->
                                    <td>{{ lancamento.area|default_if_none:"-" }}</td>
                                    <!-- Origem - pode ter m칰ltiplas origens separadas por ';' -->
                                    <!-- <td>
                                      {% if lancamento.origem %}
                                        {% if ';' in lancamento.origem %}
                                          {# Se tem m칰ltiplas origens, quebra por ';' e mostra cada uma #}
                                          {% for origem in lancamento.origem|split:';' %}
                                            <div>{{ origem|strip }}</div>
                                          {% endfor %}
                                        {% else %}
                                          {# Se tem apenas uma origem #}
                                          {{ lancamento.origem }}
                                        {% endif %}
                                      {% else %}
                                        -
                                      {% endif %}
                                    </td> -->
                                    <td>
                                        {% if lancamento.origem %}
                                          {% if ';' in lancamento.origem %}
                                            {% for origem in lancamento.origem|split:';' %}
                                              <div>
                                                {{ lancamento|origem_formatada }}
                                                {% with cartorio_nome=lancamento|origem_cartorio_especifico:origem %}
                                                  {% if cartorio_nome %}
                                                    <small class="text-muted">({{ cartorio_nome }})</small>
                                                  {% endif %}
                                                {% endwith %}
                                              </div>
                                            {% endfor %}
                                          {% else %}
                                            {{ lancamento|origem_formatada }}
                                            {% if lancamento.cartorio_origem %}
                                              <small class="text-muted">({{ lancamento.cartorio_origem.nome }})</small>
                                            {% endif %}
                                          {% endif %}
                                        {% else %}
                                          -
                                        {% endif %}
                                      </td>
                                    <!-- Observa칞칫es do lan칞amento -->
                                    <td>{{ lancamento.observacoes|default_if_none:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
        
        {# ===================================================== #}
        {# SE칂츾O DE ESTAT칈STICAS                               #}
        {# ===================================================== #}
        {% if estatisticas %}
        <div class="estatisticas">
            <h3>游늳 Estat칤sticas da Cadeia Completa</h3>
            <div class="estatisticas-grid">
                <div class="estatisticas-item">
                    <div class="estatisticas-valor">{{ estatisticas.total_documentos }}</div>
                    <div class="estatisticas-label">Documentos</div>
                </div>
                <div class="estatisticas-item">
                    <div class="estatisticas-valor">{{ estatisticas.total_lancamentos }}</div>
                    <div class="estatisticas-label">Lan칞amentos</div>
                </div>
                <div class="estatisticas-item">
                    <div class="estatisticas-valor">{{ estatisticas.total_troncos }}</div>
                    <div class="estatisticas-label">Troncos</div>
                </div>
                <div class="estatisticas-item">
                    <div class="estatisticas-valor">{{ estatisticas.documentos_importados }}</div>
                    <div class="estatisticas-label">Importados</div>
                </div>
            </div>
        </div>
        {% endif %}
    {% endif %}
    

</body>
</html>
