{% extends "base.html" %}
{% load static %}

{% block title %}Documento Detalhado - {{ documento.numero }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dominial/css/cadeia_dominial_tabela.css' %}">
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container">
    <div class="cadeia-header">
        <h1>
            <svg class="header-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M16 13H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M16 17H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M10 9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Documento Detalhado
        </h1>
        <div class="imovel-info">
            <div>
                <strong>Imóvel:</strong>
                {{ imovel.nome }}
            </div>
            <div>
                <strong>Matrícula:</strong>
                {{ imovel.matricula }}
            </div>
            <div>
                <strong>Proprietário:</strong>
                {{ imovel.proprietario.nome }}
            </div>
            {% if imovel.sncr %}
            <div>
                <strong>SNCR:</strong>
                {{ imovel.sncr }}
            </div>
            {% endif %}
            {% if imovel.cartorio %}
            <div>
                <strong>Cartório:</strong>
                {{ imovel.cartorio.nome }}
            </div>
            {% endif %}
        </div>
    </div>

    <div class="field-group">
        <h4>
            <svg class="section-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 6H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8 12H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M3 6H3.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M3 12H3.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M3 18H3.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            {{ documento.tipo.get_tipo_display }}: {{ documento.numero }}
        </h4>
        
        <div class="documento-info">
            <div class="info-grid">
                <div class="info-item">
                    <strong>Data:</strong> {{ documento.data|date:'d/m/Y' }}
                </div>
                <div class="info-item">
                    <strong>Cartório:</strong> {{ documento.cartorio.nome }}
                </div>
                <div class="info-item">
                    <strong>Livro:</strong> {{ documento.livro }}
                </div>
                <div class="info-item">
                    <strong>Folha:</strong> {{ documento.folha }}
                </div>
            </div>
            
            {% if documento.origem %}
            <div class="origem-info">
                <strong>Origem:</strong> {{ documento.origem }}
            </div>
            {% endif %}
            
            {% if documento.observacoes %}
            <div class="observacoes-info">
                <strong>Observações:</strong> {{ documento.observacoes }}
            </div>
            {% endif %}
        </div>
    </div>

    {% if tem_lancamentos %}
        <!-- Tabela de Lançamentos -->
        <div class="cadeia-tabela-container">
            <table class="cadeia-tabela-planilha">
                <thead>
                    <tr>
                        <th colspan="5" class="agrupamento">MATRÍCULA</th>
                        <th colspan="2" class="agrupamento">&nbsp;</th>
                        <th colspan="6" class="agrupamento">TRANSMISSÃO</th>
                        <th rowspan="2">Área (ha)</th>
                        <th rowspan="2">Origem</th>
                        <th rowspan="2">Observações</th>
                    </tr>
                    <tr>
                        <!-- Matrícula -->
                        <th>Nº</th>
                        <th>L</th>
                        <th>Fls.</th>
                        <th>Cartório</th>
                        <th>Data</th>
                        <!-- Transmitente/Adquirente -->
                        <th>Transmitente</th>
                        <th>Adquirente</th>
                        <!-- Transmissão -->
                        <th>Forma</th>
                        <th>Título</th>
                        <th>Cartório</th>
                        <th>L</th>
                        <th>Fls.</th>
                        <th>Data</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lancamento in lancamentos %}
                    <tr class="planilha-row {% cycle 'linha-par' 'linha-impar' %}">
                        <!-- Matrícula -->
                        <td>{{ lancamento.numero_lancamento }}</td>
                        <td>{{ documento.livro|default_if_none:"-" }}</td>
                        <td>{{ documento.folha|default_if_none:"-" }}</td>
                        <td>
                            {% if documento.cri_origem %}
                                {{ documento.cri_origem.nome }}
                            {% elif documento.cri_atual %}
                                {{ documento.cri_atual.nome }}
                            {% else %}
                                {{ documento.cartorio.nome }}
                            {% endif %}
                        </td>
                        <td>{{ lancamento.data|date:'d/m/Y' }}</td>
                        <!-- Transmitente -->
                        <td>
                            {% for pessoa in lancamento.transmitentes.all %}
                                {{ pessoa.pessoa.nome }}{% if not forloop.last %}, {% endif %}
                            {% empty %}-{% endfor %}
                        </td>
                        <!-- Adquirente -->
                        <td>
                            {% for pessoa in lancamento.adquirentes.all %}
                                {{ pessoa.pessoa.nome }}{% if not forloop.last %}, {% endif %}
                            {% empty %}-{% endfor %}
                        </td>
                        <!-- Transmissão -->
                        {% if lancamento.tipo.tipo == 'averbacao' %}
                            <td colspan="6">
                                {% if lancamento.descricao and lancamento.descricao|length > 100 %}
                                    <span class="descricao-curta">{{ lancamento.descricao|slice:":100" }}...</span>
                                    <span class="descricao-completa" style="display:none;">{{ lancamento.descricao }}</span>
                                    <a href="#" class="ler-mais" onclick="toggleDescricao(this); return false;">Ler mais</a>
                                {% else %}
                                    {{ lancamento.descricao|default_if_none:"-" }}
                                {% endif %}
                            </td>
                        {% else %}
                            <td>{{ lancamento.forma|default_if_none:"-" }}</td>
                            <td>{{ lancamento.titulo|default_if_none:"-" }}</td>
                            <td>{% if lancamento.cartorio_transmissao_compat %}{{ lancamento.cartorio_transmissao_compat.nome }}{% else %}-{% endif %}</td>
                            <td>{{ lancamento.livro_transacao|default_if_none:"-" }}</td>
                            <td>{{ lancamento.folha_transacao|default_if_none:"-" }}</td>
                            <td>
                                {% if lancamento.data_transacao %}
                                    {{ lancamento.data_transacao|date:'d/m/Y' }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        {% endif %}
                        <!-- Restante -->
                        <td>{{ lancamento.area|default_if_none:"-" }}</td>
                        <td>{{ lancamento.origem|default_if_none:"-" }}</td>
                        <td>{{ lancamento.observacoes|default_if_none:"-" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="empty-state">
            <h3>Nenhum lançamento encontrado</h3>
            <p>Este documento ainda não possui lançamentos registrados.</p>
        </div>
    {% endif %}

    <!-- Botão para adicionar novo lançamento -->
    <div class="actions">
        <a href="{% url 'novo_lancamento_documento' tis_id=tis.id imovel_id=imovel.id documento_id=documento.id %}" class="btn btn-success">
            ➕ Adicionar Lançamento
        </a>
        <a href="{% url 'cadeia_dominial' tis_id=tis.id imovel_id=imovel.id %}" class="btn btn-secondary">
            ← Voltar para Cadeia Dominial
        </a>
    </div>
</div>
{% endblock %} 