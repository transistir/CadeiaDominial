{% extends "base.html" %}

{% block title %}{% if modo_edicao %}Editar{% else %}Novo{% endif %} Lan√ßamento - {{ imovel.nome }}{% endblock %}

{% block content %}
<div class="container">
    <h1>{% if modo_edicao %}Editar{% else %}Novo{% endif %} Lan√ßamento</h1>

    {% include "dominial/components/_documento_resumo.html" %}

    <form method="post">
        {% csrf_token %}
        
        <!-- Substituir bloco de informa√ß√µes b√°sicas pelo componente -->
        {% include "dominial/components/_lancamento_basico_form.html" %}

        <!-- Campos para Averba√ß√£o -->
        {% include "dominial/components/_lancamento_averbacao_form.html" %}

        <!-- Campos para Registro -->
        {% include "dominial/components/_lancamento_registro_form.html" %}

        <!-- Campos para In√≠cio de Matr√≠cula -->
        <div class="field-group" id="campos-inicio-matricula" style="display: none;">
            <h4>Campos Espec√≠ficos - In√≠cio de Matr√≠cula</h4>
            
            <div class="form-group">
                <label for="forma_inicio">Forma *</label>
                <input type="text" name="forma_inicio" id="forma_inicio" placeholder="Ex: Abertura, Cria√ß√£o, etc."
                       value="{% if modo_edicao and lancamento.forma %}{{ lancamento.forma }}{% elif form_data and form_data.forma %}{{ form_data.forma }}{% else %}{% endif %}">
            </div>

            <div class="form-group">
                <label for="descricao_inicio">Descri√ß√£o *</label>
                <textarea name="descricao" id="descricao_inicio" placeholder="Descreva o motivo do in√≠cio da matr√≠cula">{% if modo_edicao %}{{ lancamento.descricao }}{% elif form_data %}{{ form_data.descricao }}{% endif %}</textarea>
            </div>
        </div>

        <!-- Campos Opcionais de Transa√ß√£o -->
        <div class="field-group" id="campos-transacao" style="display: none;">
            <h4>Campos Opcionais - Transa√ß√£o</h4>
            
            <div class="grid-2">
                {% include "dominial/components/_pessoa_form.html" with tipo="transmitente" label="Transmitente(s)" container_id="transmitentes-container" sugestao_class="transmitente-suggestions" %}
                {% include "dominial/components/_pessoa_form.html" with tipo="adquirente" label="Adquirente(s)" container_id="adquirentes-container" sugestao_class="adquirente-suggestions" %}
            </div>

            {% include "dominial/components/_area_origem_form.html" with area_obrigatorio=False origem_obrigatorio=False %}
        </div>

        {% include "dominial/components/_observacoes_form.html" with observacoes_obrigatorio=False placeholder="Observa√ß√µes adicionais sobre o lan√ßamento" %}

        <!-- Checkbox para finalizar -->
        <div class="field-group" style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
            <div class="toggle-group">
                <label class="toggle-label">
                    <input type="checkbox" name="finalizar" id="finalizar" class="toggle-checkbox">
                    <span>{% if modo_edicao %}Finalizar e voltar √† visualiza√ß√£o dos lan√ßamentos{% else %}Finalizar e voltar √† visualiza√ß√£o dos lan√ßamentos{% endif %}</span>
                </label>
                <small style="display: block; margin-top: 5px; color: #666;">
                    Marque esta op√ß√£o se deseja finalizar e voltar √† visualiza√ß√£o dos lan√ßamentos deste documento. 
                    Se desmarcado, ser√° redirecionado para criar um novo lan√ßamento.
                </small>
            </div>
        </div>

        <div class="actions">
            <button type="submit" class="btn btn-success">Salvar Lan√ßamento</button>
            <a href="{% url 'documento_lancamentos' tis_id=tis.id imovel_id=imovel.id documento_id=documento.id %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elementos do formul√°rio
    const tipoSelect = document.getElementById('tipo_lancamento');
    const averbacaoFields = document.getElementById('campos-averbacao');
    const registroFields = document.getElementById('campos-registro');
    const inicioMatriculaFields = document.getElementById('campos-inicio-matricula');
    const transacaoFields = document.getElementById('campos-transacao');
    
    // Fun√ß√£o para alternar campos baseado no tipo selecionado
    function toggleFields() {
        const selectedOption = tipoSelect.options[tipoSelect.selectedIndex];
        const selectedTipo = selectedOption ? selectedOption.getAttribute('data-tipo') : '';
        const modoEdicao = {% if modo_edicao %}true{% else %}false{% endif %};
        
        // Esconder todos os campos primeiro
        averbacaoFields.style.display = 'none';
        registroFields.style.display = 'none';
        inicioMatriculaFields.style.display = 'none';
        transacaoFields.style.display = 'none';
        
        // Mostrar campos baseado no tipo selecionado
        if (selectedTipo === 'averbacao') {
            averbacaoFields.style.display = 'block';
            transacaoFields.style.display = 'block';
        } else if (selectedTipo === 'registro') {
            registroFields.style.display = 'block';
            transacaoFields.style.display = 'block';
        } else if (selectedTipo === 'inicio_matricula') {
            inicioMatriculaFields.style.display = 'block';
            transacaoFields.style.display = 'block';
        }
    }
    
    // Inicializar campos ap√≥s um pequeno delay para garantir que o DOM est√° pronto
    setTimeout(() => {
        toggleFields();
        
        // Carregar dados de pessoas existentes se estiver em modo de edi√ß√£o
        if ({% if modo_edicao %}true{% else %}false{% endif %}) {
            // Carregar transmitentes existentes
            {% if modo_edicao and transmitentes %}
                {% for transmitente in transmitentes %}
                (function() {
                    const container = document.getElementById('transmitentes-container');
                    const pessoaDiv = document.createElement('div');
                    pessoaDiv.className = 'pessoa-item';
                    pessoaDiv.innerHTML = `
                        <div class="pessoa-input-group">
                            <div class="autocomplete-container">
                                <input type="text" name="transmitente_nome[]" class="transmitente-nome" placeholder="Digite o nome do transmitente" autocomplete="off" value="{{ transmitente.pessoa.nome }}">
                                <input type="hidden" name="transmitente[]" class="transmitente-id" value="{{ transmitente.pessoa.id }}">
                                <div class="autocomplete-suggestions transmitente-suggestions"></div>
                            </div>
                            <input type="number" name="transmitente_percentual[]" class="percentual-input" placeholder="%" min="0" max="100" step="0.01" style="width: 80px;" value="{{ transmitente.percentual }}">
                            <button type="button" class="btn btn-sm btn-danger remove-pessoa" onclick="removePessoa(this)" style="padding: 2px 6px;">√ó</button>
                        </div>
                    `;
                    container.appendChild(pessoaDiv);
                })();
                {% endfor %}
            {% endif %}
            
            // Carregar adquirentes existentes
            {% if modo_edicao and adquirentes %}
                {% for adquirente in adquirentes %}
                (function() {
                    const container = document.getElementById('adquirentes-container');
                    const pessoaDiv = document.createElement('div');
                    pessoaDiv.className = 'pessoa-item';
                    pessoaDiv.innerHTML = `
                        <div class="pessoa-input-group">
                            <div class="autocomplete-container">
                                <input type="text" name="adquirente_nome[]" class="adquirente-nome" placeholder="Digite o nome do adquirente" autocomplete="off" value="{{ adquirente.pessoa.nome }}">
                                <input type="hidden" name="adquirente[]" class="adquirente-id" value="{{ adquirente.pessoa.id }}">
                                <div class="autocomplete-suggestions adquirente-suggestions"></div>
                            </div>
                            <input type="number" name="adquirente_percentual[]" class="percentual-input" placeholder="%" min="0" max="100" step="0.01" style="width: 80px;" value="{{ adquirente.percentual }}">
                            <button type="button" class="btn btn-sm btn-danger remove-pessoa" onclick="removePessoa(this)" style="padding: 2px 6px;">√ó</button>
                        </div>
                    `;
                    container.appendChild(pessoaDiv);
                })();
                {% endfor %}
            {% endif %}
            
            // Remover os campos vazios iniciais
            const transmitentesContainer = document.getElementById('transmitentes-container');
            const adquirentesContainer = document.getElementById('adquirentes-container');
            
            if (transmitentesContainer && transmitentesContainer.children.length > 1) {
                transmitentesContainer.removeChild(transmitentesContainer.firstElementChild);
            }
            if (adquirentesContainer && adquirentesContainer.children.length > 1) {
                adquirentesContainer.removeChild(adquirentesContainer.firstElementChild);
            }
        }
    }, 100);
    
    // Adicionar listener para mudan√ßas no tipo
    tipoSelect.addEventListener('change', toggleFields);
    
    // Configurar autocomplete para pessoas existentes e adicionar listeners para novos campos
    setupPessoaAutocomplete();
    
    // Autocomplete para cart√≥rio
    const cartorioInput = document.getElementById('cartorio_origem_nome');
    const cartorioHidden = document.getElementById('cartorio_origem');
    const cartorioSuggestions = document.querySelector('.cartorio-suggestions');
    
    if (cartorioInput && cartorioHidden && cartorioSuggestions) {
        setupCartorioAutocomplete(cartorioInput, cartorioHidden, cartorioSuggestions);
    }
    
    // Autocomplete para cart√≥rio da averba√ß√£o
    const cartorioAverbacaoInput = document.getElementById('cartorio_origem_nome_averbacao');
    const cartorioAverbacaoHidden = document.getElementById('cartorio_origem_averbacao');
    const cartorioAverbacaoSuggestions = document.querySelector('.cartorio-suggestions-averbacao');
    
    if (cartorioAverbacaoInput && cartorioAverbacaoHidden && cartorioAverbacaoSuggestions) {
        setupCartorioAutocomplete(cartorioAverbacaoInput, cartorioAverbacaoHidden, cartorioAverbacaoSuggestions);
    }
    
    // Controle dos campos de cart√≥rio na averba√ß√£o
    const incluirCartorioCheckbox = document.getElementById('incluir_cartorio_averbacao');
    const camposCartorioAverbacao = document.getElementById('campos-cartorio-averbacao');
    
    if (incluirCartorioCheckbox && camposCartorioAverbacao) {
        // Verificar se h√° dados preenchidos para mostrar os campos
        const hasCartorioData = {% if modo_edicao and lancamento.cartorio_origem %}true{% else %}false{% endif %};
        
        if (hasCartorioData) {
            incluirCartorioCheckbox.checked = true;
            camposCartorioAverbacao.style.display = 'block';
        }
        
        incluirCartorioCheckbox.addEventListener('change', function() {
            if (this.checked) {
                camposCartorioAverbacao.style.display = 'block';
                // Adicionar anima√ß√£o suave
                camposCartorioAverbacao.style.opacity = '0';
                camposCartorioAverbacao.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    camposCartorioAverbacao.style.transition = 'all 0.3s ease';
                    camposCartorioAverbacao.style.opacity = '1';
                    camposCartorioAverbacao.style.transform = 'translateY(0)';
                }, 10);
            } else {
                // Adicionar anima√ß√£o suave antes de esconder
                camposCartorioAverbacao.style.transition = 'all 0.3s ease';
                camposCartorioAverbacao.style.opacity = '0';
                camposCartorioAverbacao.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    camposCartorioAverbacao.style.display = 'none';
                }, 300);
            }
        });
    }
    
    function setupPessoaAutocomplete() {
        // Configurar autocomplete para campos existentes
        document.querySelectorAll('.transmitente-nome, .adquirente-nome').forEach(input => {
            setupPessoaFieldAutocomplete(input);
        });
        
        // Configurar autocomplete para novos campos que ser√£o adicionados
        document.addEventListener('DOMContentLoaded', function() {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) { // Element node
                            const newInputs = node.querySelectorAll ? node.querySelectorAll('.transmitente-nome, .adquirente-nome') : [];
                            newInputs.forEach(input => {
                                setupPessoaFieldAutocomplete(input);
                            });
                        }
                    });
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });
    }
    
    function setupPessoaFieldAutocomplete(input) {
        const hiddenInput = input.parentElement.querySelector('input[type="hidden"]');
        const suggestions = input.parentElement.querySelector('.autocomplete-suggestions');
        
        if (!hiddenInput || !suggestions) return;
        
        let selectedIndex = -1;
        let suggestionsData = [];
        
        input.addEventListener('input', function() {
            const query = this.value.trim();
            if (query.length < 2) {
                hideSuggestions();
                return;
            }
            
            fetch(`/dominial/pessoa-autocomplete/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    suggestionsData = data;
                    showSuggestions(data);
                })
                .catch(error => {
                    console.error('Erro ao buscar sugest√µes de pessoa:', error);
                });
        });
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectNext();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectPrevious();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                selectCurrent();
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        });
        
        input.addEventListener('blur', function() {
            setTimeout(() => {
                hideSuggestions();
            }, 200);
        });
        
        function showSuggestions(data) {
            if (data.length === 0) {
                suggestions.innerHTML = '<div class="autocomplete-suggestion"><div class="nome">Nenhuma pessoa encontrada</div></div>';
            } else {
                suggestions.innerHTML = data.map((item, index) => `
                    <div class="autocomplete-suggestion" data-index="${index}" data-id="${item.id}">
                        <div class="nome">${item.nome}</div>
                        ${item.cpf ? `<div class="cpf">CPF: ${item.cpf}</div>` : ''}
                    </div>
                `).join('');
                
                suggestions.innerHTML += `
                    <div class="autocomplete-suggestion novo" data-index="new">
                        <div class="nome">‚ûï Criar nova pessoa: "${input.value}"</div>
                    </div>
                `;
            }
            
            suggestions.style.display = 'block';
            selectedIndex = -1;
        }
        
        function hideSuggestions() {
            suggestions.style.display = 'none';
            selectedIndex = -1;
        }
        
        function selectNext() {
            const items = suggestions.querySelectorAll('.autocomplete-suggestion');
            if (items.length === 0) return;
            
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            updateSelection(items);
        }
        
        function selectPrevious() {
            const items = suggestions.querySelectorAll('.autocomplete-suggestion');
            if (items.length === 0) return;
            
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection(items);
        }
        
        function updateSelection(items) {
            items.forEach((item, index) => {
                item.classList.remove('selected');
                if (index === selectedIndex) {
                    item.classList.add('selected');
                }
            });
        }
        
        function selectCurrent() {
            const items = suggestions.querySelectorAll('.autocomplete-suggestion');
            if (selectedIndex >= 0 && selectedIndex < items.length) {
                const selectedItem = items[selectedIndex];
                const index = selectedItem.getAttribute('data-index');
                
                if (index === 'new') {
                    input.value = input.value.trim();
                    hiddenInput.value = '';
                } else {
                    const pessoa = suggestionsData[index];
                    input.value = pessoa.nome;
                    hiddenInput.value = pessoa.id;
                }
            }
            hideSuggestions();
        }
        
        suggestions.addEventListener('click', function(e) {
            const suggestion = e.target.closest('.autocomplete-suggestion');
            if (suggestion) {
                const index = suggestion.getAttribute('data-index');
                
                if (index === 'new') {
                    input.value = input.value.trim();
                    hiddenInput.value = '';
                } else {
                    const pessoa = suggestionsData[index];
                    input.value = pessoa.nome;
                    hiddenInput.value = pessoa.id;
                }
                hideSuggestions();
            }
        });
    }
    
    function setupCartorioAutocomplete(input, hidden, suggestions) {
        let selectedIndex = -1;
        let suggestionsData = [];
        
        input.addEventListener('input', function() {
            const query = this.value.trim();
            if (query.length < 2) {
                hideSuggestions();
                return;
            }
            
            fetch(`/dominial/cartorio-autocomplete/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    suggestionsData = data;
                    showSuggestions(data);
                })
                .catch(error => {
                    console.error('Erro ao buscar sugest√µes de cart√≥rio:', error);
                });
        });
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectNext();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectPrevious();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                selectCurrent();
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        });
        
        input.addEventListener('blur', function() {
            setTimeout(() => {
                hideSuggestions();
            }, 200);
        });
        
        function showSuggestions(data) {
            if (data.length === 0) {
                suggestions.innerHTML = '<div class="autocomplete-suggestion"><div class="nome">Nenhum cart√≥rio encontrado</div></div>';
            } else {
                suggestions.innerHTML = data.map((item, index) => `
                    <div class="autocomplete-suggestion" data-index="${index}" data-id="${item.id}">
                        <div class="nome">${item.nome}</div>
                        ${item.cidade ? `<div class="cidade">Cidade: ${item.cidade}</div>` : ''}
                    </div>
                `).join('');
                
                suggestions.innerHTML += `
                    <div class="autocomplete-suggestion novo" data-index="new">
                        <div class="nome">‚ûï Criar novo cart√≥rio: "${input.value}"</div>
                    </div>
                `;
            }
            
            suggestions.style.display = 'block';
            selectedIndex = -1;
        }
        
        function hideSuggestions() {
            suggestions.style.display = 'none';
            selectedIndex = -1;
        }
        
        function selectNext() {
            const items = suggestions.querySelectorAll('.autocomplete-suggestion');
            if (items.length === 0) return;
            
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            updateSelection(items);
        }
        
        function selectPrevious() {
            const items = suggestions.querySelectorAll('.autocomplete-suggestion');
            if (items.length === 0) return;
            
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection(items);
        }
        
        function updateSelection(items) {
            items.forEach((item, index) => {
                item.classList.remove('selected');
                if (index === selectedIndex) {
                    item.classList.add('selected');
                }
            });
        }
        
        function selectCurrent() {
            const items = suggestions.querySelectorAll('.autocomplete-suggestion');
            if (selectedIndex >= 0 && selectedIndex < items.length) {
                const selectedItem = items[selectedIndex];
                const index = selectedItem.getAttribute('data-index');
                
                if (index === 'new') {
                    input.value = input.value.trim();
                    hidden.value = '';
                } else {
                    const cartorio = suggestionsData[index];
                    input.value = cartorio.nome;
                    hidden.value = cartorio.id;
                }
            }
            hideSuggestions();
        }
        
        suggestions.addEventListener('click', function(e) {
            const suggestion = e.target.closest('.autocomplete-suggestion');
            if (suggestion) {
                const index = suggestion.getAttribute('data-index');
                
                if (index === 'new') {
                    input.value = input.value.trim();
                    hidden.value = '';
                } else {
                    const cartorio = suggestionsData[index];
                    input.value = cartorio.nome;
                    hidden.value = cartorio.id;
                }
                hideSuggestions();
            }
        });
    }
    
    // Fun√ß√µes para m√∫ltiplas pessoas
    window.adicionarTransmitente = function() {
        const container = document.getElementById('transmitentes-container');
        const pessoaDiv = document.createElement('div');
        pessoaDiv.className = 'pessoa-item';
        pessoaDiv.innerHTML = `
            <div class="pessoa-input-group">
                <div class="autocomplete-container">
                    <input type="text" name="transmitente_nome[]" class="transmitente-nome" placeholder="Digite o nome do transmitente" autocomplete="off">
                    <input type="hidden" name="transmitente[]" class="transmitente-id" value="">
                    <div class="autocomplete-suggestions transmitente-suggestions"></div>
                </div>
                <input type="number" name="transmitente_percentual[]" class="percentual-input" placeholder="%" min="0" max="100" step="0.01" style="width: 80px;">
                <button type="button" class="btn btn-sm btn-danger remove-pessoa" onclick="removePessoa(this)" style="padding: 2px 6px;">√ó</button>
            </div>
        `;
        container.appendChild(pessoaDiv);
    };
    
    window.adicionarAdquirente = function() {
        const container = document.getElementById('adquirentes-container');
        const pessoaDiv = document.createElement('div');
        pessoaDiv.className = 'pessoa-item';
        pessoaDiv.innerHTML = `
            <div class="pessoa-input-group">
                <div class="autocomplete-container">
                    <input type="text" name="adquirente_nome[]" class="adquirente-nome" placeholder="Digite o nome do adquirente" autocomplete="off">
                    <input type="hidden" name="adquirente[]" class="adquirente-id" value="">
                    <div class="autocomplete-suggestions adquirente-suggestions"></div>
                </div>
                <input type="number" name="adquirente_percentual[]" class="percentual-input" placeholder="%" min="0" max="100" step="0.01" style="width: 80px;">
                <button type="button" class="btn btn-sm btn-danger remove-pessoa" onclick="removePessoa(this)" style="padding: 2px 6px;">√ó</button>
            </div>
        `;
        container.appendChild(pessoaDiv);
    };
    
    window.removePessoa = function(button) {
        const pessoaItem = button.closest('.pessoa-item');
        const container = pessoaItem?.parentElement;
        
        // N√£o permitir remover se for o √∫ltimo item
        if (container && container.children.length > 1) {
            pessoaItem.remove();
        }
    };
    
    // Valida√ß√£o do campo de origem
    const origemInput = document.getElementById('origem');
    const origemValidation = document.getElementById('origem-validation');
    
    if (origemInput && origemValidation) {
        origemInput.addEventListener('input', function() {
            const valor = this.value;
            const codigos = valor.match(/\b[A-Za-z]\d+\b/g) || [];
            const codigosInvalidos = [];
            const sugestoes = [];
            
            codigos.forEach(codigo => {
                const prefixo = codigo.charAt(0).toUpperCase();
                const numero = codigo.substring(1);
                
                // Verificar se √© um c√≥digo v√°lido (M ou T seguido de n√∫meros)
                if (!/^[MT]\d+$/i.test(codigo)) {
                    codigosInvalidos.push(codigo);
                    
                    // Gerar sugest√£o baseada no prefixo
                    if (/^[A-Za-z]\d+$/i.test(codigo)) {
                        if (prefixo === 'M' || prefixo === 'T') {
                            sugestoes.push(`${prefixo}${numero}`);
                        } else {
                            // Se n√£o √© M nem T, sugerir M (matr√≠cula √© mais comum)
                            sugestoes.push(`M${numero}`);
                        }
                    }
                }
            });
            
            // Mostrar valida√ß√£o se houver c√≥digos inv√°lidos
            if (codigosInvalidos.length > 0) {
                let mensagem = '<div style="color: #856404; background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 8px; border-radius: 4px;">';
                mensagem += '<strong>‚ö†Ô∏è C√≥digos detectados que n√£o seguem o padr√£o:</strong><br>';
                mensagem += codigosInvalidos.map((codigo, index) => {
                    const sugestao = sugestoes[index];
                    return `‚Ä¢ "${codigo}" ‚Üí sugerido: "${sugestao}"`;
                }).join('<br>');
                mensagem += '<br><small>üí° Use M para matr√≠culas e T para transcri√ß√µes</small>';
                mensagem += '</div>';
                
                origemValidation.innerHTML = mensagem;
                origemValidation.style.display = 'block';
            } else {
                origemValidation.style.display = 'none';
            }
        });
        
        // Tamb√©m validar ao perder o foco
        origemInput.addEventListener('blur', function() {
            // Pequeno delay para permitir que o usu√°rio veja a valida√ß√£o
            setTimeout(() => {
                if (origemValidation.style.display === 'block') {
                    origemValidation.style.display = 'none';
                }
            }, 2000);
        });
    }
});
</script>
{% endblock %}

{% block extra_css %}
<style>
/* Campo de erro */
.error-field {
    border: 2px solid #dc3545 !important;
    background-color: #fff5f5 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

.error-field:focus {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

.error-message {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.input-group {
    display: flex;
    align-items: center;
    gap: 5px;
}

.input-group input {
    flex: 1;
}

.btn-sm {
    padding: 5px 10px;
    font-size: 0.875em;
    border-radius: 4px;
    min-width: 35px;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: white;
}

.btn-danger {
    background: #dc3545;
    color: white;
    border: 1px solid #dc3545;
}

.btn-danger:hover {
    background: #c82333;
    border-color: #bd2130;
}

.origem-item {
    transition: all 0.2s ease;
}

.origem-item:hover {
    background: #e9ecef !important;
}

.origens-container {
    max-height: 200px;
    overflow-y: auto;
}

/* Autocomplete Styles */
.autocomplete-container {
    position: relative;
}

.autocomplete-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.autocomplete-suggestion {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s ease;
}

.autocomplete-suggestion:hover {
    background-color: #f8f9fa;
}

.autocomplete-suggestion:last-child {
    border-bottom: none;
}

.autocomplete-suggestion.selected {
    background-color: #e3f2fd;
}

.autocomplete-suggestion .nome {
    font-weight: 500;
    color: #333;
}

.autocomplete-suggestion .cpf {
    font-size: 0.85em;
    color: #666;
    margin-top: 2px;
}

.autocomplete-suggestion .novo {
    color: #28a745;
    font-style: italic;
}

/* M√∫ltiplas Pessoas Styles */
.pessoa-item {
    margin-bottom: 10px;
}

.pessoa-input-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.percentual-input {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 8px;
    font-size: 0.9em;
}

.percentual-total {
    margin-top: 5px;
    font-size: 0.9em;
    font-weight: 500;
    color: #666;
}

.percentual-total.warning {
    color: #dc3545;
}

.percentual-total.success {
    color: #28a745;
}

/* Estilos para campos de cart√≥rio da averba√ß√£o */
#campos-cartorio-averbacao {
    transition: all 0.3s ease;
}

#campos-cartorio-averbacao h5 {
    margin-bottom: 15px;
    font-weight: 600;
    color: #495057;
}

#campos-cartorio-averbacao .form-group {
    margin-bottom: 12px;
}

#campos-cartorio-averbacao .grid-3 {
    gap: 12px;
}

/* Anima√ß√£o para mostrar/ocultar campos */
.field-group {
    transition: all 0.3s ease;
}

.toggle-group {
    transition: background-color 0.2s ease;
}

.toggle-group:hover {
    background-color: #e9ecef !important;
}
</style>
{% endblock %} 