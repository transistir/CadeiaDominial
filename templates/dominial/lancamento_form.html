{% extends "base.html" %}
{% load static %}

{% block title %}{% if modo_edicao %}Editar{% else %}Novo{% endif %} Lançamento - {{ imovel.nome }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dominial/css/forms.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <h1>{% if modo_edicao %}✏️ Editar{% else %}➕ Novo{% endif %} Lançamento</h1>
    
    <div class="field-group">
        <h4>{{ imovel.nome }}</h4>
        <div class="grid-3">
            <div>
                <strong>Matrícula:</strong> {{ imovel.matricula }}
            </div>
            <div>
                <strong>SNCR:</strong> {{ imovel.sncr }}
            </div>
            <div>
                <strong>Proprietário Atual:</strong> {{ imovel.proprietario.nome }}
            </div>
        </div>
    </div>

    <form method="post" id="lancamento-form">
        {% csrf_token %}
        
        <!-- Campos Básicos -->
        {% include "dominial/components/_lancamento_basico_form.html" %}

        <!-- Campos para Averbacao -->
        {% include "dominial/components/_lancamento_averbacao_form.html" %}

        <!-- Campos para Registro -->
        {% include "dominial/components/_lancamento_registro_form.html" %}

        <!-- Campos para Início de Matrícula -->
        <div class="field-group hidden" id="campos-inicio-matricula">
            <h4>Campos Específicos - Início de Matrícula</h4>
            
            <div class="form-group">
                <label for="forma_inicio">Forma *</label>
                <input type="text" name="forma_inicio" id="forma_inicio" placeholder="Ex: Abertura, Criação, etc."
                       value="{% if modo_edicao and lancamento.forma %}{{ lancamento.forma }}{% elif form_data and form_data.forma %}{{ form_data.forma }}{% else %}{% endif %}">
            </div>

            <div class="form-group">
                <label for="descricao_inicio">Descrição *</label>
                <textarea name="descricao" id="descricao_inicio" placeholder="Descreva o motivo do início da matrícula">{% if modo_edicao %}{{ lancamento.descricao }}{% elif form_data %}{{ form_data.descricao }}{% endif %}</textarea>
            </div>
        </div>

        <!-- Campos Opcionais de Transação -->
        <div class="field-group hidden" id="campos-transacao">
            <h4>Campos Opcionais - Transação</h4>
            
            <div class="grid-2">
                {% include "dominial/components/_pessoa_form.html" with tipo="transmitente" label="Transmitente(s)" container_id="transmitentes-container" sugestao_class="transmitente-suggestions" %}
                {% include "dominial/components/_pessoa_form.html" with tipo="adquirente" label="Adquirente(s)" container_id="adquirentes-container" sugestao_class="adquirente-suggestions" %}
            </div>

            {% include "dominial/components/_area_origem_form.html" with area_obrigatorio=False origem_obrigatorio=False %}
        </div>

        {% include "dominial/components/_observacoes_form.html" with observacoes_obrigatorio=False placeholder="Observações adicionais sobre o lançamento" %}

        <div class="form-actions">
            <button type="submit" class="btn btn-success">Salvar Lançamento</button>
            <a href="{% url 'documento_lancamentos' tis_id=tis.id imovel_id=imovel.id documento_id=documento.id %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elementos do formulário
    const tipoSelect = document.getElementById('tipo_lancamento');
    const averbacaoFields = document.getElementById('campos-averbacao');
    const registroFields = document.getElementById('campos-registro');
    const inicioMatriculaFields = document.getElementById('campos-inicio-matricula');
    const transacaoFields = document.getElementById('campos-transacao');
    
    // Função para alternar campos baseado no tipo selecionado
    function toggleFields() {
        const selectedOption = tipoSelect.options[tipoSelect.selectedIndex];
        const selectedTipo = selectedOption ? selectedOption.getAttribute('data-tipo') : '';
        const modoEdicao = {% if modo_edicao %}true{% else %}false{% endif %};
        
        // Esconder todos os campos primeiro
        averbacaoFields.classList.add('hidden');
        registroFields.classList.add('hidden');
        inicioMatriculaFields.classList.add('hidden');
        transacaoFields.classList.add('hidden');
        
        // Mostrar campos baseado no tipo selecionado
        if (selectedTipo === 'averbacao') {
            averbacaoFields.classList.remove('hidden');
            transacaoFields.classList.remove('hidden');
        } else if (selectedTipo === 'registro') {
            registroFields.classList.remove('hidden');
            transacaoFields.classList.remove('hidden');
        } else if (selectedTipo === 'inicio_matricula') {
            inicioMatriculaFields.classList.remove('hidden');
            transacaoFields.classList.remove('hidden');
        }
    }
    
    // Inicializar campos após um pequeno delay para garantir que o DOM está pronto
    setTimeout(() => {
        toggleFields();
        
        // Carregar dados de pessoas existentes se estiver em modo de edição
        if ({% if modo_edicao %}true{% else %}false{% endif %}) {
            // Carregar transmitentes existentes
            {% if modo_edicao and transmitentes %}
                {% for transmitente in transmitentes %}
                (function() {
                    const container = document.getElementById('transmitentes-container');
                    const pessoaDiv = document.createElement('div');
                    pessoaDiv.className = 'pessoa-item';
                    pessoaDiv.innerHTML = `
                        <div class="pessoa-input-group">
                            <div class="autocomplete-container">
                                <input type="text" name="transmitente_nome[]" class="transmitente-nome" placeholder="Digite o nome do transmitente" autocomplete="off" value="{{ transmitente.pessoa.nome }}">
                                <input type="hidden" name="transmitente[]" class="transmitente-id" value="{{ transmitente.pessoa.id }}">
                                <div class="autocomplete-suggestions transmitente-suggestions"></div>
                            </div>
                            <input type="number" name="transmitente_percentual[]" class="percentual-input" placeholder="%" min="0" max="100" step="0.01" value="{{ transmitente.percentual }}">
                            <button type="button" class="btn btn-sm btn-danger remove-pessoa" onclick="removePessoa(this)">×</button>
                        </div>
                    `;
                    container.appendChild(pessoaDiv);
                })();
                {% endfor %}
            {% endif %}
            
            // Carregar adquirentes existentes
            {% if modo_edicao and adquirentes %}
                {% for adquirente in adquirentes %}
                (function() {
                    const container = document.getElementById('adquirentes-container');
                    const pessoaDiv = document.createElement('div');
                    pessoaDiv.className = 'pessoa-item';
                    pessoaDiv.innerHTML = `
                        <div class="pessoa-input-group">
                            <div class="autocomplete-container">
                                <input type="text" name="adquirente_nome[]" class="adquirente-nome" placeholder="Digite o nome do adquirente" autocomplete="off" value="{{ adquirente.pessoa.nome }}">
                                <input type="hidden" name="adquirente[]" class="adquirente-id" value="{{ adquirente.pessoa.id }}">
                                <div class="autocomplete-suggestions adquirente-suggestions"></div>
                            </div>
                            <input type="number" name="adquirente_percentual[]" class="percentual-input" placeholder="%" min="0" max="100" step="0.01" value="{{ adquirente.percentual }}">
                            <button type="button" class="btn btn-sm btn-danger remove-pessoa" onclick="removePessoa(this)">×</button>
                        </div>
                    `;
                    container.appendChild(pessoaDiv);
                })();
                {% endfor %}
            {% endif %}
            
            // Remover os campos vazios iniciais
            const transmitentesContainer = document.getElementById('transmitentes-container');
            const adquirentesContainer = document.getElementById('adquirentes-container');
            
            if (transmitentesContainer && transmitentesContainer.children.length > 1) {
                transmitentesContainer.removeChild(transmitentesContainer.firstElementChild);
            }
            if (adquirentesContainer && adquirentesContainer.children.length > 1) {
                adquirentesContainer.removeChild(adquirentesContainer.firstElementChild);
            }
        }
    }, 100);
    
    // Adicionar listener para mudanças no tipo
    tipoSelect.addEventListener('change', toggleFields);
    
    // Configurar autocomplete para pessoas existentes e adicionar listeners para novos campos
    setupPessoaAutocomplete();
    
    // Autocomplete para cartório
    const cartorioInput = document.getElementById('cartorio_origem_nome');
    const cartorioHidden = document.getElementById('cartorio_origem');
    const cartorioSuggestions = document.querySelector('.cartorio-suggestions');
    
    if (cartorioInput && cartorioHidden && cartorioSuggestions) {
        setupCartorioAutocomplete(cartorioInput, cartorioHidden, cartorioSuggestions);
    }
    
    // Autocomplete para cartório da averbação
    const cartorioAverbacaoInput = document.getElementById('cartorio_origem_nome_averbacao');
    const cartorioAverbacaoHidden = document.getElementById('cartorio_origem_averbacao');
    const cartorioAverbacaoSuggestions = document.querySelector('.cartorio-suggestions-averbacao');
    
    if (cartorioAverbacaoInput && cartorioAverbacaoHidden && cartorioAverbacaoSuggestions) {
        setupCartorioAutocomplete(cartorioAverbacaoInput, cartorioAverbacaoHidden, cartorioAverbacaoSuggestions);
    }
    
    // Controle dos campos de cartório na averbação
    const incluirCartorioCheckbox = document.getElementById('incluir_cartorio_averbacao');
    const camposCartorioAverbacao = document.getElementById('campos-cartorio-averbacao');
    
    if (incluirCartorioCheckbox && camposCartorioAverbacao) {
        // Verificar se há dados preenchidos para mostrar os campos
        const hasCartorioData = {% if modo_edicao and lancamento.cartorio_origem %}true{% else %}false{% endif %};
        
        if (hasCartorioData) {
            incluirCartorioCheckbox.checked = true;
            camposCartorioAverbacao.classList.remove('hidden');
        }
        
        incluirCartorioCheckbox.addEventListener('change', function() {
            if (this.checked) {
                camposCartorioAverbacao.classList.remove('hidden');
                camposCartorioAverbacao.classList.add('fade-in');
            } else {
                camposCartorioAverbacao.classList.add('fade-out');
                setTimeout(() => {
                    camposCartorioAverbacao.classList.add('hidden');
                    camposCartorioAverbacao.classList.remove('fade-out');
                }, 300);
            }
        });
    }
});

// Função para remover pessoa
function removePessoa(button) {
    const pessoaItem = button.closest('.pessoa-item');
    if (pessoaItem) {
        pessoaItem.remove();
    }
}

// Função para adicionar transmitente
function adicionarTransmitente() {
    const container = document.getElementById('transmitentes-container');
    const pessoaDiv = document.createElement('div');
    pessoaDiv.className = 'pessoa-item';
    pessoaDiv.innerHTML = `
        <div class="pessoa-input-group">
            <div class="autocomplete-container">
                <input type="text" name="transmitente_nome[]" class="transmitente-nome" placeholder="Digite o nome do transmitente" autocomplete="off">
                <input type="hidden" name="transmitente[]" class="transmitente-id">
                <div class="autocomplete-suggestions transmitente-suggestions"></div>
            </div>
            <input type="number" name="transmitente_percentual[]" class="percentual-input" placeholder="%" min="0" max="100" step="0.01">
            <button type="button" class="btn btn-sm btn-danger remove-pessoa" onclick="removePessoa(this)">×</button>
        </div>
    `;
    container.appendChild(pessoaDiv);
    
    // Configurar autocomplete para o novo campo
    const newInput = pessoaDiv.querySelector('.transmitente-nome');
    const newHidden = pessoaDiv.querySelector('.transmitente-id');
    const newSuggestions = pessoaDiv.querySelector('.transmitente-suggestions');
    setupPessoaAutocompleteField(newInput, newHidden, newSuggestions, 'transmitente');
}

// Função para adicionar adquirente
function adicionarAdquirente() {
    const container = document.getElementById('adquirentes-container');
    const pessoaDiv = document.createElement('div');
    pessoaDiv.className = 'pessoa-item';
    pessoaDiv.innerHTML = `
        <div class="pessoa-input-group">
            <div class="autocomplete-container">
                <input type="text" name="adquirente_nome[]" class="adquirente-nome" placeholder="Digite o nome do adquirente" autocomplete="off">
                <input type="hidden" name="adquirente[]" class="adquirente-id">
                <div class="autocomplete-suggestions adquirente-suggestions"></div>
            </div>
            <input type="number" name="adquirente_percentual[]" class="percentual-input" placeholder="%" min="0" max="100" step="0.01">
            <button type="button" class="btn btn-sm btn-danger remove-pessoa" onclick="removePessoa(this)">×</button>
        </div>
    `;
    container.appendChild(pessoaDiv);
    
    // Configurar autocomplete para o novo campo
    const newInput = pessoaDiv.querySelector('.adquirente-nome');
    const newHidden = pessoaDiv.querySelector('.adquirente-id');
    const newSuggestions = pessoaDiv.querySelector('.adquirente-suggestions');
    setupPessoaAutocompleteField(newInput, newHidden, newSuggestions, 'adquirente');
}

// Função para configurar autocomplete de pessoa
function setupPessoaAutocompleteField(input, hidden, suggestions, tipo) {
    input.addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length < 2) {
            suggestions.style.display = 'none';
            return;
        }
        
        fetch(`/api/pessoas/autocomplete/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                suggestions.innerHTML = '';
                if (data.results && data.results.length > 0) {
                    data.results.forEach(pessoa => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-suggestion';
                        div.textContent = pessoa.nome;
                        div.addEventListener('click', function() {
                            input.value = pessoa.nome;
                            hidden.value = pessoa.id;
                            suggestions.style.display = 'none';
                        });
                        suggestions.appendChild(div);
                    });
                    suggestions.style.display = 'block';
                } else {
                    suggestions.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Erro ao buscar pessoas:', error);
                suggestions.style.display = 'none';
            });
    });
    
    // Esconder sugestões quando clicar fora
    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !suggestions.contains(e.target)) {
            suggestions.style.display = 'none';
        }
    });
}

// Função para configurar autocomplete de cartório
function setupCartorioAutocomplete(input, hidden, suggestions) {
    input.addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length < 2) {
            suggestions.style.display = 'none';
            return;
        }
        
        fetch(`/api/cartorios/autocomplete/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                suggestions.innerHTML = '';
                if (data.results && data.results.length > 0) {
                    data.results.forEach(cartorio => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-suggestion';
                        div.textContent = cartorio.nome;
                        div.addEventListener('click', function() {
                            input.value = cartorio.nome;
                            hidden.value = cartorio.id;
                            suggestions.style.display = 'none';
                        });
                        suggestions.appendChild(div);
                    });
                    suggestions.style.display = 'block';
                } else {
                    suggestions.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Erro ao buscar cartórios:', error);
                suggestions.style.display = 'none';
            });
    });
    
    // Esconder sugestões quando clicar fora
    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !suggestions.contains(e.target)) {
            suggestions.style.display = 'none';
        }
    });
}

// Função para configurar autocomplete geral de pessoas
function setupPessoaAutocomplete() {
    const transmitenteInputs = document.querySelectorAll('.transmitente-nome');
    const adquirenteInputs = document.querySelectorAll('.adquirente-nome');
    
    transmitenteInputs.forEach((input, index) => {
        const hidden = document.querySelectorAll('.transmitente-id')[index];
        const suggestions = document.querySelectorAll('.transmitente-suggestions')[index];
        setupPessoaAutocompleteField(input, hidden, suggestions, 'transmitente');
    });
    
    adquirenteInputs.forEach((input, index) => {
        const hidden = document.querySelectorAll('.adquirente-id')[index];
        const suggestions = document.querySelectorAll('.adquirente-suggestions')[index];
        setupPessoaAutocompleteField(input, hidden, suggestions, 'adquirente');
    });
}
</script>
{% endblock %} 