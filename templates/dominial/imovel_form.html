{% extends "base.html" %}
{% load i18n static %}

{% block title %}Cadastro de Im√≥vel - {{ tis.nome }}{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        padding: 30px;
        margin-bottom: 20px;
        border: 1px solid #e1e8ed;
    }

    .form-header {
        margin-bottom: 30px;
        text-align: center;
        padding-bottom: 20px;
        border-bottom: 2px solid #ecf0f1;
    }

    .form-header h1 {
        color: #2c3e50;
        margin: 0 0 10px 0;
        font-size: 28px;
        font-weight: 600;
    }

    .form-header .tis-info {
        color: #7f8c8d;
        font-size: 16px;
    }

    .form-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 25px;
        border: 1px solid #e9ecef;
    }

    .form-section h3 {
        color: #2c3e50;
        margin: 0 0 15px 0;
        font-size: 18px;
        font-weight: 600;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 10px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #34495e;
        font-size: 14px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #ecf0f1;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s ease;
        background: white;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .form-group textarea {
        min-height: 100px;
        resize: vertical;
    }

    .form-group select:disabled {
        background-color: #f8f9fa;
        color: #6c757d;
        cursor: not-allowed;
    }

    .error-message {
        color: #e74c3c;
        font-size: 12px;
        margin-top: 5px;
        font-weight: 500;
    }

    .button-group {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        justify-content: center;
        padding-top: 20px;
        border-top: 1px solid #ecf0f1;
    }

    .submit-button {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .submit-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        background: linear-gradient(135deg, #2980b9, #1f5f8b);
    }

    .back-button {
        background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        color: white;
        text-decoration: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .back-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        background: linear-gradient(135deg, #7f8c8d, #6c7b7d);
        color: white;
        text-decoration: none;
    }

    .form-info {
        margin-bottom: 20px;
        padding: 15px;
        background: #e8f4fd;
        border-radius: 8px;
        color: #2c3e50;
        border-left: 4px solid #3498db;
    }

    .import-banner {
        display: none;
        margin: 20px 0;
        padding: 20px;
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        color: #856404;
        border-left: 4px solid #f39c12;
    }

    .import-banner.show {
        display: block;
    }

    .import-banner .banner-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .import-banner .banner-text {
        flex-grow: 1;
        margin-right: 15px;
    }

    .import-banner .banner-button {
        background: linear-gradient(135deg, #27ae60, #229954);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .import-banner .banner-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .import-banner .banner-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .import-banner .loading {
        display: none;
        margin-left: 10px;
    }

    .import-banner .loading.show {
        display: inline-block;
    }

    .import-status {
        display: none;
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 14px;
        border: 1px solid #e9ecef;
    }

    .import-status.show {
        display: block;
    }

    .import-status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .import-status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .import-status .status-text {
        margin-bottom: 10px;
        font-weight: 600;
    }

    .import-status .progress-bar {
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 10px;
    }

    .import-status .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #27ae60, #229954);
        width: 0%;
        transition: width 0.3s ease;
    }

    .import-status .progress-text {
        font-size: 12px;
        color: #6c757d;
        text-align: center;
    }

    #campos_novo_proprietario {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 20px;
        margin-top: 15px;
        border-left: 4px solid #3498db;
    }

    /* Estilos para o modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
        backdrop-filter: blur(2px);
    }

    .modal-content {
        background: white;
        margin: 5% auto;
        padding: 0;
        border: none;
        width: 90%;
        max-width: 600px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        padding: 25px 30px 20px;
        border-bottom: 1px solid #ecf0f1;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 12px 12px 0 0;
    }

    .modal-header h3 {
        margin: 0;
        color: #2c3e50;
        font-size: 20px;
        font-weight: 600;
    }

    .close {
        color: #95a5a6;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
        transition: color 0.2s ease;
    }

    .close:hover,
    .close:focus {
        color: #2c3e50;
        text-decoration: none;
        cursor: pointer;
    }

    .modal-body {
        padding: 30px;
    }

    .modal-buttons {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px solid #ecf0f1;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .btn-primary {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        color: white;
    }

    .btn-secondary:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    @media (max-width: 768px) {
        .grid-2 {
            grid-template-columns: 1fr;
        }
        
        .button-group {
            flex-direction: column;
        }
        
        .modal-content {
            width: 95%;
            margin: 10% auto;
        }
        
        .modal-header {
            padding: 20px;
        }
        
        .modal-body {
            padding: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <div class="form-header">
        <h1>Cadastro de Im√≥vel</h1>
        <div class="tis-info">Terra Ind√≠gena: {{ tis.nome }}</div>
    </div>

    <form method="post">
        {% csrf_token %}
        
        <div class="form-section">
            <h3>üìã Informa√ß√µes do Propriet√°rio</h3>
            
            <div class="form-group">
                <label for="{{ form.proprietario_nome.id_for_label }}">Nome do Propriet√°rio:</label>
                {{ form.proprietario_nome }}
                {{ form.proprietario }}
            </div>

            <div id="campos_novo_proprietario" style="display: none;">
                <h4>Novo Propriet√°rio</h4>
                <div class="grid-2">
                    <div class="form-group">
                        <label for="cpf">CPF:</label>
                        <input type="text" id="cpf" name="cpf" class="form-control" placeholder="000.000.000-00">
                    </div>
                    <div class="form-group">
                        <label for="rg">RG:</label>
                        <input type="text" id="rg" name="rg" class="form-control" placeholder="00.000.000-0">
                    </div>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label for="data_nascimento">Data de Nascimento:</label>
                        <input type="date" id="data_nascimento" name="data_nascimento" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="telefone">Telefone:</label>
                        <input type="text" id="telefone" name="telefone" class="form-control" placeholder="(00) 00000-0000">
                    </div>
                </div>
                <div class="form-group">
                    <label for="email">E-mail:</label>
                    <input type="email" id="email" name="email" class="form-control" placeholder="email@exemplo.com">
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>üè† Informa√ß√µes do Im√≥vel</h3>
            
            <div class="form-group">
                <label for="{{ form.nome.id_for_label }}">Nome do Im√≥vel:</label>
                {{ form.nome }}
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label for="{{ form.matricula.id_for_label }}">Matr√≠cula:</label>
                    {{ form.matricula }}
                </div>
                <div class="form-group">
                    <label for="{{ form.sncr.id_for_label }}">SNCR:</label>
                    {{ form.sncr }}
                </div>
            </div>

            <div class="form-group">
                <label for="{{ form.sigef.id_for_label }}">SIGEF:</label>
                {{ form.sigef }}
            </div>

            <div class="form-group">
                <label for="{{ form.descricao.id_for_label }}">Descri√ß√£o:</label>
                {{ form.descricao }}
            </div>

            <div class="form-group">
                <label for="{{ form.observacoes.id_for_label }}">Observa√ß√µes:</label>
                {{ form.observacoes }}
            </div>
        </div>

        <div class="form-section">
            <h3>üìç Localiza√ß√£o e Cart√≥rio</h3>
            
            <div class="grid-2">
                <div class="form-group">
                    <label for="estado">Estado:</label>
                    <select class="form-control" id="estado" required>
                        <option value="">Selecione um estado</option>
                        <option value="AC">Acre</option>
                        <option value="AL">Alagoas</option>
                        <option value="AM">Amazonas</option>
                        <option value="AP">Amap√°</option>
                        <option value="BA">Bahia</option>
                        <option value="CE">Cear√°</option>
                        <option value="DF">Distrito Federal</option>
                        <option value="ES">Esp√≠rito Santo</option>
                        <option value="GO">Goi√°s</option>
                        <option value="MA">Maranh√£o</option>
                        <option value="MG">Minas Gerais</option>
                        <option value="MS">Mato Grosso do Sul</option>
                        <option value="MT">Mato Grosso</option>
                        <option value="PA">Par√°</option>
                        <option value="PB">Para√≠ba</option>
                        <option value="PE">Pernambuco</option>
                        <option value="PI">Piau√≠</option>
                        <option value="PR">Paran√°</option>
                        <option value="RJ">Rio de Janeiro</option>
                        <option value="RN">Rio Grande do Norte</option>
                        <option value="RO">Rond√¥nia</option>
                        <option value="RR">Roraima</option>
                        <option value="RS">Rio Grande do Sul</option>
                        <option value="SC">Santa Catarina</option>
                        <option value="SE">Sergipe</option>
                        <option value="SP">S√£o Paulo</option>
                        <option value="TO">Tocantins</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cidade_select">Cidade:</label>
                    <select class="form-control" id="cidade_select" disabled>
                        <option value="">Selecione uma cidade</option>
                    </select>
                    {{ form.cidade }}
                </div>
            </div>

            <div class="form-group">
                <label for="cartorio">Cart√≥rio:</label>
                <select class="form-control" id="cartorio" name="cartorio" disabled>
                    <option value="">Selecione um cart√≥rio</option>
                    <option value="novo">‚ûï Adicionar novo cart√≥rio</option>
                </select>
                <input type="hidden" name="cartorio_id" id="cartorio_id">
            </div>

            <!-- Modal para adicionar novo cart√≥rio -->
            <div id="modal-novo-cartorio" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Adicionar Novo Cart√≥rio</h3>
                        <span class="close" onclick="fecharModalCartorio()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="form-novo-cartorio">
                            <div class="form-group">
                                <label for="novo-cartorio-nome">Nome do Cart√≥rio:</label>
                                <input type="text" id="novo-cartorio-nome" name="nome" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="novo-cartorio-cns">CNS:</label>
                                <input type="text" id="novo-cartorio-cns" name="cns" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="novo-cartorio-endereco">Endere√ßo:</label>
                                <input type="text" id="novo-cartorio-endereco" name="endereco" class="form-control">
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label for="novo-cartorio-telefone">Telefone:</label>
                                    <input type="text" id="novo-cartorio-telefone" name="telefone" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="novo-cartorio-email">E-mail:</label>
                                    <input type="email" id="novo-cartorio-email" name="email" class="form-control">
                                </div>
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label for="novo-cartorio-estado">Estado:</label>
                                    <select id="novo-cartorio-estado" name="estado" class="form-control" required>
                                        <option value="">Selecione um estado</option>
                                        <option value="AC">Acre</option>
                                        <option value="AL">Alagoas</option>
                                        <option value="AM">Amazonas</option>
                                        <option value="AP">Amap√°</option>
                                        <option value="BA">Bahia</option>
                                        <option value="CE">Cear√°</option>
                                        <option value="DF">Distrito Federal</option>
                                        <option value="ES">Esp√≠rito Santo</option>
                                        <option value="GO">Goi√°s</option>
                                        <option value="MA">Maranh√£o</option>
                                        <option value="MG">Minas Gerais</option>
                                        <option value="MS">Mato Grosso do Sul</option>
                                        <option value="MT">Mato Grosso</option>
                                        <option value="PA">Par√°</option>
                                        <option value="PB">Para√≠ba</option>
                                        <option value="PE">Pernambuco</option>
                                        <option value="PI">Piau√≠</option>
                                        <option value="PR">Paran√°</option>
                                        <option value="RJ">Rio de Janeiro</option>
                                        <option value="RN">Rio Grande do Norte</option>
                                        <option value="RO">Rond√¥nia</option>
                                        <option value="RR">Roraima</option>
                                        <option value="RS">Rio Grande do Sul</option>
                                        <option value="SC">Santa Catarina</option>
                                        <option value="SE">Sergipe</option>
                                        <option value="SP">S√£o Paulo</option>
                                        <option value="TO">Tocantins</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="novo-cartorio-cidade">Cidade:</label>
                                    <input type="text" id="novo-cartorio-cidade" name="cidade" class="form-control" required>
                                </div>
                            </div>
                            <div class="modal-buttons">
                                <button type="button" onclick="fecharModalCartorio()" class="btn btn-secondary">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Salvar Cart√≥rio</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="cartorio-info" class="form-info" style="display: none;">
                <h5>Informa√ß√µes do Cart√≥rio</h5>
                <div class="grid-2">
                    <div><strong>Respons√°vel:</strong> <span id="cartorio-responsavel">-</span></div>
                    <div><strong>CNS:</strong> <span id="cartorio-cns">-</span></div>
                </div>
                <div><strong>Endere√ßo:</strong> <span id="cartorio-endereco">-</span></div>
                <div class="grid-2">
                    <div><strong>Telefone:</strong> <span id="cartorio-telefone">-</span></div>
                    <div><strong>E-mail:</strong> <span id="cartorio-email">-</span></div>
                </div>
            </div>
        </div>

        <div id="import-banner" class="import-banner">
            <div class="banner-content">
                <div class="banner-text">
                    <strong>Nenhum cart√≥rio encontrado para este estado.</strong><br>
                    Clique no bot√£o abaixo para importar cart√≥rios automaticamente da base oficial.
                </div>
                <button id="import-button" class="banner-button">
                    <span>Importar Cart√≥rios</span>
                    <span class="loading">‚è≥</span>
                </button>
            </div>
            <div id="import-status" class="import-status">
                <div class="status-text">Iniciando importa√ß√£o...</div>
                <div class="progress-bar">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="progress-text">0%</div>
            </div>
        </div>

        <div class="button-group">
            <a href="{% url 'tis_detail' tis.id %}" class="back-button">‚Üê Voltar</a>
            <button type="submit" class="submit-button">üíæ Salvar Im√≥vel</button>
        </div>
    </form>
</div>

<script>
// Fun√ß√µes globais para o modal de novo cart√≥rio
function abrirModalCartorio() {
    console.log('Abrindo modal de novo cart√≥rio');
    const modal = document.getElementById('modal-novo-cartorio');
    if (modal) {
        modal.style.display = 'block';
        // Preencher estado e cidade automaticamente se j√° selecionados
        const estadoSelecionado = document.getElementById('estado');
        const cidadeSelecionada = document.getElementById('cidade_select');
        
        if (estadoSelecionado && estadoSelecionado.value) {
            const novoEstado = document.getElementById('novo-cartorio-estado');
            if (novoEstado) {
                novoEstado.value = estadoSelecionado.value;
            }
        }
        if (cidadeSelecionada && cidadeSelecionada.value) {
            const novaCidade = document.getElementById('novo-cartorio-cidade');
            if (novaCidade) {
                novaCidade.value = cidadeSelecionada.value;
            }
        }
    }
}

function fecharModalCartorio() {
    const modal = document.getElementById('modal-novo-cartorio');
    if (modal) {
        modal.style.display = 'none';
    }
    // Resetar o select de cart√≥rio
    const cartorioSelect = document.getElementById('cartorio');
    const cartorioId = document.getElementById('cartorio_id');
    const cartorioInfo = document.getElementById('cartorio-info');
    
    if (cartorioSelect) {
        cartorioSelect.value = '';
    }
    if (cartorioId) {
        cartorioId.value = '';
    }
    if (cartorioInfo) {
        cartorioInfo.style.display = 'none';
    }
}

// Fechar modal ao clicar fora dele
function fecharModalClick(event) {
    const modal = document.getElementById('modal-novo-cartorio');
    if (event.target === modal) {
        fecharModalCartorio();
    }
}

// Fun√ß√£o para criar novo cart√≥rio
function criarNovoCartorio(cartorioData) {
    const csrf_token = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    
    return fetch('/dominial/criar-cartorio/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrf_token
        },
        body: JSON.stringify(cartorioData)
    })
    .then(response => response.json());
}

// Fun√ß√£o para adicionar cart√≥rio ao select
function adicionarCartorioAoSelect(cartorioData) {
    const cartorioSelect = document.getElementById('cartorio');
    if (cartorioSelect) {
        const option = document.createElement('option');
        option.value = cartorioData.id;
        option.textContent = cartorioData.nome;
        option.dataset.info = JSON.stringify(cartorioData);
        cartorioSelect.appendChild(option);
        
        // Selecionar o novo cart√≥rio
        cartorioSelect.value = cartorioData.id;
    }
    
    const cartorioId = document.getElementById('cartorio_id');
    if (cartorioId) {
        cartorioId.value = cartorioData.id;
    }
    
    // Mostrar informa√ß√µes do cart√≥rio
    const responsavel = document.getElementById('cartorio-responsavel');
    const endereco = document.getElementById('cartorio-endereco');
    const telefone = document.getElementById('cartorio-telefone');
    const email = document.getElementById('cartorio-email');
    const cns = document.getElementById('cartorio-cns');
    
    if (responsavel) {
        responsavel.textContent = cartorioData.responsavel || 'N√£o informado';
    }
    if (endereco) {
        endereco.textContent = cartorioData.endereco || 'N√£o informado';
    }
    if (telefone) {
        telefone.textContent = cartorioData.telefone || 'N√£o informado';
    }
    if (email) {
        email.textContent = cartorioData.email || 'N√£o informado';
    }
    if (cns) {
        cns.textContent = cartorioData.cns || 'N√£o informado';
    }
    
    const cartorioInfo = document.getElementById('cartorio-info');
    if (cartorioInfo) {
        cartorioInfo.style.display = 'block';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const estadoSelect = document.getElementById('estado');
    const cidadeSelect = document.getElementById('cidade_select');
    const cidadeHidden = document.getElementById('id_cidade');
    const cartorioSelect = document.getElementById('cartorio');
    const cartorioInfo = document.getElementById('cartorio-info');
    const importBanner = document.getElementById('import-banner');
    const importButton = document.getElementById('import-button');
    const loadingSpan = document.querySelector('.loading');
    const importStatus = document.getElementById('import-status');
    const progressBarFill = document.querySelector('.progress-bar-fill');
    const progressText = document.querySelector('.progress-text');
    const statusText = document.querySelector('.status-text');
    const csrf_token = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    
    // Fun√ß√£o para verificar cart√≥rios do estado
    function verificarCartorios(estado) {
        fetch('/dominial/verificar-cartorios/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrf_token
            },
            body: `estado=${estado}`
        })
        .then(response => response.json())
        .then(data => {
            if (importBanner) {
                if (!data.existem_cartorios) {
                    importBanner.classList.add('show');
                } else {
                    importBanner.classList.remove('show');
                }
            }
        })
        .catch(error => console.error('Erro ao verificar cart√≥rios:', error));
    }

    // Fun√ß√£o para atualizar o progresso
    function updateProgress(progress) {
        if (progressBarFill) {
            progressBarFill.style.width = `${progress}%`;
        }
        if (progressText) {
            progressText.textContent = `${progress}%`;
        }
    }

    // Fun√ß√£o para mostrar status
    function showStatus(message, isSuccess = false, isError = false) {
        if (statusText) {
            statusText.textContent = message;
        }
        if (importStatus) {
            importStatus.classList.add('show');
            if (isSuccess) {
                importStatus.classList.add('success');
                importStatus.classList.remove('error');
            } else if (isError) {
                importStatus.classList.add('error');
                importStatus.classList.remove('success');
            } else {
                importStatus.classList.remove('success', 'error');
            }
        }
    }

    // Fun√ß√£o para importar cart√≥rios
    function importarCartorios(estado) {
        if (!importButton) return;
        
        importButton.disabled = true;
        if (loadingSpan) {
            loadingSpan.classList.add('show');
        }
        if (importStatus) {
            importStatus.classList.remove('success', 'error');
        }
        showStatus('Iniciando importa√ß√£o...');
        updateProgress(0);

        // Simular progresso durante a importa√ß√£o
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 5;
            if (progress <= 90) {
                updateProgress(progress);
            }
        }, 500);

        fetch('/dominial/importar-cartorios/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrf_token
            },
            body: `estado=${estado}`
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);
            updateProgress(100);
            
            if (data.success) {
                showStatus(data.message, true);
                // Resetar o campo de estado
                if (estadoSelect) {
                    estadoSelect.value = '';
                }
                if (cidadeSelect) {
                    cidadeSelect.disabled = true;
                    cidadeSelect.innerHTML = '<option value="">Selecione uma cidade</option>';
                }
                if (cartorioSelect) {
                    cartorioSelect.disabled = true;
                    cartorioSelect.innerHTML = '<option value="">Selecione um cart√≥rio</option>';
                }
                if (cartorioInfo) {
                    cartorioInfo.style.display = 'none';
                }
                if (importBanner) {
                    importBanner.classList.remove('show');
                }
                
                // Recarregar a p√°gina ap√≥s um breve delay
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showStatus(data.error || 'Erro ao importar cart√≥rios', false, true);
                if (importButton) {
                    importButton.disabled = false;
                }
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            console.error('Erro ao importar cart√≥rios:', error);
            showStatus('Erro ao importar cart√≥rios. Tente novamente.', false, true);
            if (importButton) {
                importButton.disabled = false;
            }
        })
        .finally(() => {
            if (loadingSpan) {
                loadingSpan.classList.remove('show');
            }
        });
    }

    // Quando o estado √© alterado
    if (estadoSelect) {
        estadoSelect.addEventListener('change', function() {
            const estado = this.value;
            if (cidadeSelect) {
                cidadeSelect.disabled = true;
                cidadeSelect.innerHTML = '<option value="">Selecione uma cidade</option>';
            }
            if (cartorioSelect) {
                cartorioSelect.disabled = true;
                cartorioSelect.innerHTML = '<option value="">Selecione um cart√≥rio</option>';
            }
            if (cartorioInfo) {
                cartorioInfo.style.display = 'none';
            }
            if (importBanner) {
                importBanner.classList.remove('show');
            }

            if (estado) {
                // Verificar se existem cart√≥rios para o estado
                verificarCartorios(estado);

                // Buscar cidades do estado usando nossa pr√≥pria API
                fetch('/dominial/buscar-cidades/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrf_token
                    },
                    body: `estado=${estado}`
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(cidades => {
                    if (cidades && Array.isArray(cidades) && cidadeSelect) {
                        cidades.forEach(cidade => {
                            const option = document.createElement('option');
                            option.value = cidade.value;
                            option.textContent = cidade.label || cidade.value;
                            cidadeSelect.appendChild(option);
                        });
                        cidadeSelect.disabled = false;
                    } else {
                        console.error('Formato de resposta inv√°lido:', cidades);
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar cidades:', error);
                });
            }
        });
    }

    // Quando a cidade √© alterada
    if (cidadeSelect) {
        cidadeSelect.addEventListener('change', function() {
            const estado = estadoSelect ? estadoSelect.value : '';
            const cidade = this.value;
            // Atualizar o valor do campo oculto
            if (cidadeHidden) {
                cidadeHidden.value = cidade;
            }
            
            if (cartorioSelect) {
                cartorioSelect.disabled = true;
                cartorioSelect.innerHTML = '<option value="">Selecione um cart√≥rio</option>';
            }
            if (cartorioInfo) {
                cartorioInfo.style.display = 'none';
            }

            if (cidade) {
                // Buscar cart√≥rios da cidade usando nossa pr√≥pria API
                fetch('/dominial/buscar-cartorios/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrf_token
                    },
                    body: `estado=${estado}&cidade=${encodeURIComponent(cidade)}`
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(cartorios => {
                    if (cartorios && Array.isArray(cartorios) && cartorioSelect) {
                        // Adicionar a op√ß√£o "Adicionar novo cart√≥rio" no in√≠cio
                        const optionNovo = document.createElement('option');
                        optionNovo.value = 'novo';
                        optionNovo.textContent = '‚ûï Adicionar novo cart√≥rio';
                        cartorioSelect.appendChild(optionNovo);
                        
                        cartorios.forEach(cartorio => {
                            const option = document.createElement('option');
                            option.value = cartorio.id;
                            option.textContent = cartorio.nome;
                            option.dataset.info = JSON.stringify(cartorio);
                            cartorioSelect.appendChild(option);
                        });
                        cartorioSelect.disabled = false;
                    } else {
                        console.error('Formato de resposta inv√°lido:', cartorios);
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar cart√≥rios:', error);
                });
            }
        });
    }

    // Quando o cart√≥rio √© alterado
    if (cartorioSelect) {
        cartorioSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            
            if (this.value === 'novo') {
                // Abrir modal para adicionar novo cart√≥rio
                abrirModalCartorio();
                return;
            }
            
            if (selectedOption && selectedOption.dataset.info) {
                const cartorioData = JSON.parse(selectedOption.dataset.info);
                
                // Preencher campo oculto com o ID do cart√≥rio
                const cartorioId = document.getElementById('cartorio_id');
                if (cartorioId) {
                    cartorioId.value = cartorioData.id;
                }
                
                // Mostrar informa√ß√µes do cart√≥rio
                const responsavel = document.getElementById('cartorio-responsavel');
                const endereco = document.getElementById('cartorio-endereco');
                const telefone = document.getElementById('cartorio-telefone');
                const email = document.getElementById('cartorio-email');
                const cns = document.getElementById('cartorio-cns');
                
                if (responsavel) {
                    responsavel.textContent = cartorioData.responsavel || 'N√£o informado';
                }
                if (endereco) {
                    endereco.textContent = cartorioData.endereco || 'N√£o informado';
                }
                if (telefone) {
                    telefone.textContent = cartorioData.telefone || 'N√£o informado';
                }
                if (email) {
                    email.textContent = cartorioData.email || 'N√£o informado';
                }
                if (cns) {
                    cns.textContent = cartorioData.cns || 'N√£o informado';
                }
                
                if (cartorioInfo) {
                    cartorioInfo.style.display = 'block';
                }
            } else {
                const cartorioId = document.getElementById('cartorio_id');
                if (cartorioId) {
                    cartorioId.value = '';
                }
                if (cartorioInfo) {
                    cartorioInfo.style.display = 'none';
                }
            }
        });
    }

    // Fechar modal ao clicar fora dele
    window.addEventListener('click', fecharModalClick);

    // Manipular envio do formul√°rio de novo cart√≥rio
    const formNovoCartorio = document.getElementById('form-novo-cartorio');
    if (formNovoCartorio) {
        formNovoCartorio.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const cartorioData = {
                nome: formData.get('nome'),
                cns: formData.get('cns'),
                endereco: formData.get('endereco'),
                telefone: formData.get('telefone'),
                email: formData.get('email'),
                estado: formData.get('estado'),
                cidade: formData.get('cidade')
            };

            // Enviar dados para criar novo cart√≥rio
            criarNovoCartorio(cartorioData)
            .then(data => {
                if (data.success) {
                    // Adicionar novo cart√≥rio ao select
                    adicionarCartorioAoSelect(data.cartorio);
                    
                    // Fechar modal
                    fecharModalCartorio();
                    
                    // Mostrar mensagem de sucesso
                    alert('Cart√≥rio criado com sucesso!');
                } else {
                    alert('Erro ao criar cart√≥rio: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao criar cart√≥rio. Tente novamente.');
            });
        });
    }

    // Quando o bot√£o de importar √© clicado
    if (importButton) {
        importButton.addEventListener('click', function() {
            const estado = estadoSelect ? estadoSelect.value : '';
            if (estado) {
                importarCartorios(estado);
            }
        });
    }
});
</script>
{% endblock %} 